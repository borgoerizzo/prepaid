<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProjectFlow | Upravljačka ploča</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Gantt Chart Library -->
    <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.css">
    <!-- Chart.js for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --sidebar-width: 260px;
            --sidebar-width-collapsed: 82px;
        }
        body {
            font-family: 'Inter', sans-serif;
            overflow-y: hidden;
        }
        .task-card {
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s;
            cursor: grab;
        }
        .task-card:active {
            cursor: grabbing;
        }
        .dragging {
            opacity: 0.6;
            transform: rotate(3deg);
        }
        .drag-over {
            border-style: dashed;
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.05);
        }
        /* Scrollbar styling */
        .main-content::-webkit-scrollbar { width: 8px; }
        .main-content::-webkit-scrollbar-track { background: #e2e8f0; }
        .main-content::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .main-content::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .kanban-column-body::-webkit-scrollbar,
        #activity-log-container::-webkit-scrollbar,
        #global-search-results::-webkit-scrollbar,
        #roadmap-timeline::-webkit-scrollbar,
        #task-comments-list::-webkit-scrollbar,
        .workload-tasks-list::-webkit-scrollbar { width: 6px; height: 6px; }
        .kanban-column-body::-webkit-scrollbar-track,
        #activity-log-container::-webkit-scrollbar-track,
        #global-search-results::-webkit-scrollbar-track,
        #roadmap-timeline::-webkit-scrollbar-track,
        #task-comments-list::-webkit-scrollbar-track,
        .workload-tasks-list::-webkit-scrollbar-track { background: transparent; }
        .kanban-column-body::-webkit-scrollbar-thumb,
        #activity-log-container::-webkit-scrollbar-thumb,
        #global-search-results::-webkit-scrollbar-thumb,
        #roadmap-timeline::-webkit-scrollbar-thumb,
        #task-comments-list::-webkit-scrollbar-thumb,
        .workload-tasks-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .kanban-column-body::-webkit-scrollbar-thumb:hover,
        #activity-log-container::-webkit-scrollbar-thumb:hover,
        #global-search-results::-webkit-scrollbar-thumb:hover,
        #roadmap-timeline::-webkit-scrollbar-thumb:hover,
        #task-comments-list::-webkit-scrollbar-thumb:hover,
        .workload-tasks-list::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Workload tasks list fixed height and scroll */
        .workload-tasks-list { max-height: 10rem; overflow-y: auto; }

        /* Frappe Gantt Customizations */
        /* Status: Gotovo (Done) */
        #gantt-chart .gantt .bar-wrapper.gantt-status-done .bar { fill: #a7f3d0 !important; } /* emerald-200 */
        #gantt-chart .gantt .bar-wrapper.gantt-status-done .bar-progress { fill: #10b981 !important; } /* emerald-500 */
        
        /* Status: U izradi (In Progress) */
        #gantt-chart .gantt .bar-wrapper.gantt-status-inprogress .bar { fill: #c7d2fe !important; } /* indigo-200 */
        #gantt-chart .gantt .bar-wrapper.gantt-status-inprogress .bar-progress { fill: #6366f1 !important; } /* indigo-500 */

        /* Status: Za obaviti (To Do) */
        #gantt-chart .gantt .bar-wrapper.gantt-status-todo .bar { fill: #e2e8f0 !important; } /* slate-200 */
        #gantt-chart .gantt .bar-wrapper.gantt-status-todo .bar-progress { fill: #94a3b8 !important; } /* slate-400 */

        #gantt-chart .gantt .bar-label { font-size: 13px; font-weight: 500; fill: #ffffff; }
        #gantt-chart .grid-header { fill: #f8fafc; }
        #gantt-chart .grid-row:nth-child(odd) { fill: #f1f5f9; }
        #gantt-chart .gantt-container { overflow: visible; }
        #gantt-chart .grid-body .grid-row { fill: #ffffff; }

        /* Collapsible sidebar styles */
        .sidebar-text {
            white-space: nowrap;
        }
        #sidebar {
            width: var(--sidebar-width);
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #sidebar.collapsed {
            width: var(--sidebar-width-collapsed);
            overflow: visible; /* Fix for tooltips */
        }
        #sidebar.collapsed nav {
            overflow: visible; /* Ensure nav doesn't clip tooltips */
        }
        #sidebar.collapsed .sidebar-text {
            display: none;
        }
        #sidebar.collapsed .view-tab,
        #sidebar.collapsed #exportExcelBtn,
        #sidebar.collapsed #exportPdfBtn {
            justify-content: center;
        }
        #sidebar.collapsed .view-tab i,
        #sidebar.collapsed #exportExcelBtn i,
        #sidebar.collapsed #exportPdfBtn i {
            margin-right: 0;
        }
        #sidebar.collapsed .grid-cols-3 i {
            margin-bottom: 0;
        }
        .list-view-table {
            border-collapse: collapse; /* Prevents double borders */
        }
        .list-view-table tr:last-child td {
             border-bottom: none;
        }
        /* Tooltip for collapsed sidebar */
        #sidebar.collapsed .has-tooltip {
            position: relative;
        }
        #sidebar.collapsed .has-tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background-color: #1e293b; /* slate-800 */
            color: #f1f5f9; /* slate-100 */
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s 0.1s;
            pointer-events: none;
            margin-left: 12px;
        }
        #sidebar.collapsed .has-tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }
        /* Subtask strikethrough */
        .subtask-item input:checked + label {
            text-decoration: line-through;
            color: #64748b;
        }
        /* Tag styles */
        .tag-pill {
            display: inline-flex;
            align-items: center;
            background-color: #e0e7ff;
            color: #4338ca;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 500;
        }
        .tag-pill .remove-tag {
            margin-left: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-slate-800 text-white flex flex-col flex-shrink-0">
            <div class="flex items-center justify-between h-16 border-b border-slate-700 flex-shrink-0 px-4">
                 <div class="flex items-center overflow-hidden">
                    <i class="fas fa-tasks text-xl text-indigo-400 flex-shrink-0"></i>
                    <h1 class="text-xl font-bold ml-3 sidebar-text">ProjectFlow</h1>
                </div>
                <button id="sidebarToggle" class="text-slate-400 hover:bg-slate-700 hover:text-white rounded-md p-1.5" title="Sklopi/proširi">
                    <i id="sidebarToggleIcon" class="fas fa-chevron-left fa-fw w-5 h-5 transition-transform duration-300"></i>
                </button>
            </div>

            <div class="p-4 border-b border-slate-700 flex-shrink-0">
                <label class="text-xs font-semibold text-slate-400 uppercase tracking-wider px-1 sidebar-text">Projekt</label>
                <select id="projectSelector" class="w-full mt-2 bg-slate-700 border border-slate-600 rounded-md text-sm shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 p-2"></select>
                <div class="grid grid-cols-3 gap-2 mt-3">
                    <button id="newProjectBtn" class="has-tooltip bg-slate-700 hover:bg-slate-600 transition-colors p-2 rounded-md flex flex-col items-center text-xs" title="Novi projekt" data-tooltip="Novi">
                        <i class="fas fa-folder-plus mb-1"></i> <span class="sidebar-text">Novi</span>
                    </button>
                    <button id="renameProjectBtn" class="has-tooltip bg-slate-700 hover:bg-slate-600 transition-colors p-2 rounded-md flex flex-col items-center text-xs" title="Preimenuj projekt" data-tooltip="Preimenuj">
                        <i class="fas fa-edit mb-1"></i> <span class="sidebar-text">Preimenuj</span>
                    </button>
                    <button id="deleteProjectBtn" class="has-tooltip bg-slate-700 hover:bg-slate-600 transition-colors p-2 rounded-md flex flex-col items-center text-xs" title="Obriši projekt" data-tooltip="Obriši">
                        <i class="fas fa-trash mb-1"></i> <span class="sidebar-text">Obriši</span>
                    </button>
                </div>
            </div>

            <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                 <label class="text-xs font-semibold text-slate-400 uppercase tracking-wider px-3 sidebar-text">Prikaz</label>
                <button id="kanbanTab" class="view-tab has-tooltip w-full text-left flex items-center px-3 py-2.5 rounded-md font-medium text-sm transition-colors bg-slate-700 text-white" data-tooltip="Kanban">
                    <i class="fas fa-grip-vertical fa-fw mr-3 w-5"></i><span class="sidebar-text">Kanban</span>
                </button>
                <button id="listTab" class="view-tab has-tooltip w-full text-left flex items-center px-3 py-2.5 rounded-md font-medium text-sm transition-colors text-slate-300 hover:bg-slate-700 hover:text-white" data-tooltip="Lista">
                    <i class="fas fa-list-ul fa-fw mr-3 w-5"></i><span class="sidebar-text">Lista</span>
                </button>
                <button id="ganttTab" class="view-tab has-tooltip w-full text-left flex items-center px-3 py-2.5 rounded-md font-medium text-sm transition-colors text-slate-300 hover:bg-slate-700 hover:text-white" data-tooltip="Gantt">
                    <i class="fas fa-chart-gantt fa-fw mr-3 w-5"></i><span class="sidebar-text">Gantt</span>
                </button>
                <button id="workloadTab" class="view-tab has-tooltip w-full text-left flex items-center px-3 py-2.5 rounded-md font-medium text-sm transition-colors text-slate-300 hover:bg-slate-700 hover:text-white" data-tooltip="Workload">
                    <i class="fas fa-users fa-fw mr-3 w-5"></i><span class="sidebar-text">Workload</span>
                </button>
                <button id="calendarTab" class="view-tab has-tooltip w-full text-left flex items-center px-3 py-2.5 rounded-md font-medium text-sm transition-colors text-slate-300 hover:bg-slate-700 hover:text-white" data-tooltip="Kalendar">
                    <i class="fas fa-calendar-days fa-fw mr-3 w-5"></i><span class="sidebar-text">Kalendar</span>
                </button>
                 <button id="dashboardTab" class="view-tab has-tooltip w-full text-left flex items-center px-3 py-2.5 rounded-md font-medium text-sm transition-colors text-slate-300 hover:bg-slate-700 hover:text-white" data-tooltip="Dashboard">
                    <i class="fas fa-chart-pie fa-fw mr-3 w-5"></i><span class="sidebar-text">Dashboard</span>
                </button>
                <button id="roadmapTab" class="view-tab has-tooltip w-full text-left flex items-center px-3 py-2.5 rounded-md font-medium text-sm transition-colors text-slate-300 hover:bg-slate-700 hover:text-white" data-tooltip="Roadmap">
                    <i class="fas fa-route fa-fw mr-3 w-5"></i><span class="sidebar-text">Roadmap</span>
                </button>
            </nav>

            <div class="mt-auto p-4 border-t border-slate-700 space-y-2 flex-shrink-0">
                 <button id="infoBtn" class="has-tooltip w-full text-left flex items-center px-3 py-2.5 rounded-md font-medium text-sm transition-colors text-slate-300 hover:bg-slate-700 hover:text-white" data-tooltip="Info">
                    <i class="fas fa-info-circle fa-fw mr-3 w-5"></i><span class="sidebar-text">Info</span>
                </button>
                <label class="text-xs font-semibold text-slate-400 uppercase tracking-wider px-3 sidebar-text pt-2">Podaci</label>
                 <div class="grid grid-cols-2 gap-2">
                     <button id="importDataBtn" class="has-tooltip w-full bg-slate-700 hover:bg-slate-600 transition-colors p-2 rounded-md flex flex-col items-center text-xs" title="Uvezi .json" data-tooltip="Uvezi podatke">
                        <i class="fas fa-upload mb-1"></i> <span class="sidebar-text">Uvezi</span>
                    </button>
                    <button id="exportDataBtn" class="has-tooltip w-full bg-slate-700 hover:bg-slate-600 transition-colors p-2 rounded-md flex flex-col items-center text-xs" title="Izvezi .json" data-tooltip="Izvezi podatke">
                        <i class="fas fa-download mb-1"></i> <span class="sidebar-text">Izvezi</span>
                    </button>
                </div>
                <button id="exportExcelBtn" class="has-tooltip w-full bg-emerald-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md hover:bg-emerald-700 transition duration-300 flex items-center justify-center text-sm mt-2" data-tooltip="Izvezi u Excel">
                    <i class="fas fa-file-excel mr-2"></i> <span class="sidebar-text">Izvezi u Excel</span>
                </button>
                <button id="exportPdfBtn" class="has-tooltip w-full bg-red-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md hover:bg-red-700 transition duration-300 flex items-center justify-center text-sm mt-2" data-tooltip="Izvezi u PDF">
                    <i class="fas fa-file-pdf mr-2"></i> <span class="sidebar-text">Izvezi u PDF</span>
                </button>
                <input type="file" id="importFileInput" class="hidden" accept=".json">
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="flex items-center justify-between h-16 px-6 border-b border-slate-200 bg-white flex-shrink-0">
                <h2 id="viewTitle" class="text-xl font-bold text-slate-700">Kanban ploča</h2>
                <div class="flex items-center gap-4">
                     <div id="tag-filter-container" class="relative w-48"></div>
                    <div class="relative w-64" id="global-search-container">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-slate-400"></i></div>
                        <input type="text" id="globalSearch" placeholder="Pronađi zadatak..." class="block w-full pl-10 pr-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                        <div id="global-search-results" class="absolute mt-2 w-full bg-white rounded-md shadow-lg border border-slate-200 z-50 hidden max-h-80 overflow-y-auto"></div>
                    </div>
                    <button id="addTaskBtn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 flex items-center">
                        <i class="fas fa-plus mr-2"></i> Dodaj zadatak
                    </button>
                </div>
            </header>

            <div id="views" class="flex-1 overflow-x-hidden overflow-y-auto p-6 bg-slate-100 main-content">
                <!-- Kanban View -->
                <div id="kanban-view">
                    <div id="kanban-board" class="grid grid-cols-1 md:grid-cols-3 gap-6 h-full">
                        <div id="todo" class="bg-white/70 rounded-xl flex flex-col">
                            <h2 class="text-lg font-semibold p-4 border-b border-slate-200 text-slate-700 flex items-center"><i class="fas fa-list-check mr-3 text-red-500"></i>Za obaviti</h2>
                            <div data-status="todo" class="kanban-column-body flex-grow p-4 space-y-4 overflow-y-auto"></div>
                            <button class="column-add-btn m-4 bg-white border border-slate-300 text-slate-600 text-sm font-semibold py-2 px-3 rounded-md shadow-sm hover:bg-slate-50" data-status="todo"><i class="fas fa-plus mr-2"></i>Dodaj zadatak</button>
                        </div>
                        <div id="inprogress" class="bg-white/70 rounded-xl flex flex-col">
                            <h2 class="text-lg font-semibold p-4 border-b border-slate-200 text-slate-700 flex items-center"><i class="fas fa-person-digging mr-3 text-amber-500"></i>U izradi</h2>
                            <div data-status="inprogress" class="kanban-column-body flex-grow p-4 space-y-4 overflow-y-auto"></div>
                            <button class="column-add-btn m-4 bg-white border border-slate-300 text-slate-600 text-sm font-semibold py-2 px-3 rounded-md shadow-sm hover:bg-slate-50" data-status="inprogress"><i class="fas fa-plus mr-2"></i>Dodaj zadatak</button>
                        </div>
                        <div id="done" class="bg-white/70 rounded-xl flex flex-col">
                            <h2 class="text-lg font-semibold p-4 border-b border-slate-200 text-slate-700 flex items-center"><i class="fas fa-check-double mr-3 text-emerald-500"></i>Gotovo</h2>
                            <div data-status="done" class="kanban-column-body flex-grow p-4 space-y-4 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>

                <!-- Other Views -->
                <div id="list-view" class="hidden"></div>
                <div id="roadmap-view" class="hidden bg-white p-6 rounded-xl shadow-sm"></div>
                <div id="gantt-view" class="hidden bg-white p-6 rounded-xl shadow-sm"></div>
                <div id="workload-view" class="hidden"></div>
                <div id="calendar-view" class="hidden bg-white p-6 rounded-xl shadow-sm"></div>
                <div id="dashboard-view" class="hidden space-y-6">
                    <!-- Stat Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div id="stat-card-todo" class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center cursor-pointer hover:shadow-lg hover:border-indigo-400 transition-all duration-300">
                            <div class="p-4 bg-red-100 rounded-lg mr-5"><i class="fas fa-list-check text-2xl text-red-500"></i></div>
                            <div>
                                <p class="text-sm font-medium text-slate-500">Za obaviti</p>
                                <p id="todo-count" class="text-3xl font-bold text-slate-800">0</p>
                            </div>
                        </div>
                        <div id="stat-card-inprogress" class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center cursor-pointer hover:shadow-lg hover:border-indigo-400 transition-all duration-300">
                            <div class="p-4 bg-amber-100 rounded-lg mr-5"><i class="fas fa-person-digging text-2xl text-amber-500"></i></div>
                            <div>
                                <p class="text-sm font-medium text-slate-500">U izradi</p>
                                <p id="inprogress-count" class="text-3xl font-bold text-slate-800">0</p>
                            </div>
                        </div>
                        <div id="stat-card-done" class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center cursor-pointer hover:shadow-lg hover:border-indigo-400 transition-all duration-300">
                            <div class="p-4 bg-emerald-100 rounded-lg mr-5"><i class="fas fa-check-double text-2xl text-emerald-500"></i></div>
                            <div>
                                <p class="text-sm font-medium text-slate-500">Gotovo</p>
                                <p id="done-count" class="text-3xl font-bold text-slate-800">0</p>
                            </div>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-slate-800">Napredak projekta</h3>
                            <span id="progress-percentage" class="text-lg font-bold text-slate-600">0%</span>
                        </div>
                        <div class="w-full bg-red-200 rounded-full h-4">
                            <div id="progress-bar-done" class="bg-emerald-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-200"><h3 class="font-bold text-slate-800 mb-4">Zaduženja po članu tima</h3><div class="relative h-64"><canvas id="assigneePieChart"></canvas></div></div>
                        <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-sm border border-slate-200"><h3 class="font-bold text-slate-800 mb-4">Napredak članova tima (%)</h3><div class="relative h-64"><canvas id="assigneeBarChart"></canvas></div></div>
                    </div>
                     <!-- Burn-down Chart -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-800 mb-4">Burn-down grafikon</h3>
                        <div class="relative h-64"><canvas id="burnDownChart"></canvas></div>
                    </div>
                     <!-- Deadlines & Activity -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 class="font-bold text-slate-800 mb-4">Pregled rokova</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><h4 class="font-semibold text-amber-600 mb-3"><i class="fas fa-hourglass-half mr-2"></i>Uskoro istječe rok</h4><ul id="due-soon-list" class="space-y-2 text-sm"></ul></div>
                                <div><h4 class="font-semibold text-red-600 mb-3"><i class="fas fa-exclamation-circle mr-2"></i>Rok premašen</h4><ul id="overdue-list" class="space-y-2 text-sm"></ul></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 class="font-bold text-slate-800 mb-4">Dnevnik aktivnosti</h3>
                            <div id="activity-log-container" class="space-y-4 max-h-48 overflow-y-auto pr-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 p-4">
        <div id="modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-8 transform transition-all duration-300 scale-95 opacity-0 overflow-y-auto max-h-screen">
            <div class="flex items-center justify-between mb-6">
                <h3 id="modalTitle" class="text-2xl font-bold text-slate-800">Novi zadatak</h3>
                <button id="cancelBtn" class="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            <form id="taskForm">
                <input type="hidden" id="taskId"><input type="hidden" id="taskStatusPreset"><input type="hidden" id="taskProjectId">
                <div class="space-y-4">
                    <input type="text" id="taskTitle" placeholder="Naziv zadatka" class="w-full text-lg px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" required>
                    <textarea id="taskDescription" rows="3" placeholder="Dodajte opis..." class="w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"></textarea>
                    
                    <!-- Tags Section -->
                    <div class="border-t pt-4">
                        <label for="taskTagsInput" class="block text-sm font-medium text-slate-600 mb-2">Oznake (odvojite zarezom ili razmakom)</label>
                        <div id="tag-pills-container" class="flex flex-wrap gap-2 mb-2"></div>
                        <input type="text" id="taskTagsInput" placeholder="npr. #bug, #marketing..." class="w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                    </div>

                    <div id="taskProjectSelectWrapper" class="hidden">
                        <label for="taskProjectSelect" class="block text-sm font-medium text-slate-600 mb-1">Projekt</label>
                        <select id="taskProjectSelect" class="w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"></select>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="taskAssignee" class="block text-sm font-medium text-slate-600 mb-1">Zadužena osoba</label>
                            <input type="text" id="taskAssignee" class="w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="taskPriority" class="block text-sm font-medium text-slate-600 mb-1">Prioritet</label>
                            <select id="taskPriority" class="w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                                <option value="low">Nizak</option><option value="medium" selected>Srednji</option><option value="high">Visok</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="taskStartDate" class="block text-sm font-medium text-slate-600 mb-1">Datum početka</label>
                            <input type="date" id="taskStartDate" class="w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label for="taskEndDate" class="block text-sm font-medium text-slate-600 mb-1">Očekivani završetak</label>
                            <input type="date" id="taskEndDate" class="w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" required>
                        </div>
                    </div>
                    <!-- Subtasks Section -->
                    <div class="border-t pt-4">
                        <label class="block text-sm font-medium text-slate-600 mb-2">Podzadaci</label>
                        <div id="subtaskList" class="space-y-2 mb-3"></div>
                        <div class="flex gap-2">
                            <input type="text" id="newSubtaskInput" placeholder="Dodaj novi podzadatak..." class="flex-grow w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                            <button type="button" id="addSubtaskBtn" class="bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition">Dodaj</button>
                        </div>
                    </div>
                     <!-- Dependencies Section -->
                    <div class="border-t pt-4">
                        <label for="taskDependencies" class="block text-sm font-medium text-slate-600 mb-2">Ovisnosti (zadaci koji moraju biti završeni prije)</label>
                        <select id="taskDependencies" multiple class="w-full h-24 px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <!-- Comments Section -->
                    <div class="border-t pt-4">
                        <label class="block text-sm font-medium text-slate-600 mb-2">Komentari</label>
                        <div id="task-comments-list" class="space-y-3 mb-3 max-h-48 overflow-y-auto bg-slate-50 p-3 rounded-md border"></div>
                        <div class="flex gap-2 mt-3">
                            <input type="text" id="newCommentInput" placeholder="Napiši komentar..." class="flex-grow w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                            <button type="button" id="addCommentBtn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Pošalji</button>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-8">
                    <button type="button" class="cancel-btn-secondary bg-slate-100 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-200 transition">Odustani</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Spremi zadatak</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="projectModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 p-4">
        <div id="project-modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-sm p-8 transform transition-all duration-300 scale-95 opacity-0">
             <div class="flex items-center justify-between mb-6">
                <h3 id="projectModalTitle" class="text-2xl font-bold text-slate-800">Novi Projekt</h3>
                <button id="cancelProjectBtn" class="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            <form id="projectForm">
                <input type="hidden" id="projectId">
                <label for="projectName" class="block text-sm font-medium text-slate-600 mb-1">Naziv projekta</label>
                <input type="text" id="projectName" class="w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" required>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" class="cancel-btn-secondary bg-slate-100 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-200 transition">Odustani</button>
                    <button type="submit" id="submitProjectBtn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Kreiraj</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 p-4">
        <div id="confirm-modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-sm p-8 transform transition-all duration-300 scale-95 opacity-0 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
            </div>
            <h3 id="confirmTitle" class="text-xl font-bold mb-2">Potvrda akcije</h3>
            <p id="confirmMessage" class="text-slate-600 mb-6">Jeste li sigurni?</p>
            <div class="flex justify-center space-x-4">
                <button type="button" id="cancelConfirmBtn" class="bg-slate-100 text-slate-700 font-semibold py-2 px-6 rounded-lg hover:bg-slate-200 transition">Odustani</button>
                <button type="button" id="confirmActionBtn" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 transition">Potvrdi</button>
            </div>
        </div>
    </div>
    
    <div id="infoModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 p-4">
        <div id="info-modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-lg transform transition-all duration-300 scale-95 opacity-0 flex flex-col max-h-[90vh]">
            <div class="flex-shrink-0 p-6 border-b">
                 <div class="flex items-center justify-between">
                    <h3 class="text-2xl font-bold text-slate-800">O aplikaciji ProjectFlow</h3>
                    <button id="closeInfoBtn" class="text-slate-400 hover:text-slate-600">&times;</button>
                </div>
            </div>
            <div class="overflow-y-auto p-6">
                <div class="text-slate-600 space-y-4">
                    <p>ProjectFlow je jednostavna, ali moćna aplikacija za upravljanje projektima dizajnirana da vam pomogne organizirati zadatke i pratiti napredak vašeg tima.</p>
                    
                    <div class="p-4 bg-amber-100 rounded-lg text-amber-800">
                        <h4 class="font-bold mb-2"><i class="fas fa-exclamation-triangle mr-2"></i>Važna informacija o čuvanju podataka</h4>
                        <p class="text-sm">Svi vaši podaci spremaju se isključivo u vašem web pregledniku. Kako biste sačuvali svoje podatke od slučajnog brisanja ili ih prebacili na drugo računalo, redovito koristite opciju <strong>"Izvezi"</strong>. Time ćete preuzeti datoteku (`.json`) sa svim vašim projektima koju kasnije možete učitati pomoću opcije <strong>"Uvezi"</strong>.</p>
                    </div>

                    <ul class="list-disc list-inside space-y-2">
                        <li><b>Višestruki prikazi:</b> Organizirajte zadatke koristeći Kanban ploču, Listu, Gantt chart, Kalendar ili Workload prikaz.</li>
                        <li><b>Nadzorna ploča:</b> Dobijte brzi pregled statistike projekta, napretka članova tima i nadolazećih rokova.</li>
                        <li><b>Detaljno praćenje:</b> Svaki zadatak može imati podzadatke, prioritete, zadužene osobe i rokove.</li>
                        <li><b>Transparentnost:</b> Pratite sve promjene kroz Dnevnik aktivnosti i brzo pronađite bilo koji zadatak pomoću globalne pretrage.</li>
                    </ul>
                    <p>Aplikacija je napravljena kao demonstracija modernih web tehnologija i pohranjuje sve podatke lokalno u vašem pregledniku.</p>
                </div>
                 <div class="mt-6 pt-4 border-t text-center text-sm text-slate-500">
                    <p>&copy; 2025 Andrej Vukić</p>
                    <p>andrej.vukic@protonmail.com</p>
                </div>
            </div>
             <div class="flex-shrink-0 p-6 border-t flex justify-end">
                 <button id="closeInfoBtnFooter" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Zatvori</button>
            </div>
        </div>
    </div>

    <!-- Comment Tooltip -->
    <div id="comment-tooltip" class="hidden absolute z-[100] max-w-xs p-3 text-sm font-normal text-white bg-slate-800 rounded-lg shadow-lg pointer-events-none"></div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elementi ---
            const addTaskBtn = document.getElementById('addTaskBtn');
            const newProjectBtn = document.getElementById('newProjectBtn');
            const renameProjectBtn = document.getElementById('renameProjectBtn');
            const deleteProjectBtn = document.getElementById('deleteProjectBtn');
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            const projectSelector = document.getElementById('projectSelector');
            const kanbanColumns = document.querySelectorAll('.kanban-column-body');
            const taskModal = document.getElementById('taskModal');
            const taskModalContent = document.getElementById('modal-content');
            const cancelBtn = document.getElementById('cancelBtn');
            const taskForm = document.getElementById('taskForm');
            const modalTitle = document.getElementById('modalTitle');
            const projectModal = document.getElementById('projectModal');
            const projectModalContent = document.getElementById('project-modal-content');
            const projectModalTitle = document.getElementById('projectModalTitle');
            const cancelProjectBtn = document.getElementById('cancelProjectBtn');
            const projectForm = document.getElementById('projectForm');
            const submitProjectBtn = document.getElementById('submitProjectBtn');
            const confirmModal = document.getElementById('confirmModal');
            const confirmModalContent = document.getElementById('confirm-modal-content');
            const confirmTitle = document.getElementById('confirmTitle');
            const confirmMessage = document.getElementById('confirmMessage');
            const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
            const confirmActionBtn = document.getElementById('confirmActionBtn');
            const infoBtn = document.getElementById('infoBtn');
            const infoModal = document.getElementById('infoModal');
            const infoModalContent = document.getElementById('info-modal-content');
            const closeInfoBtn = document.getElementById('closeInfoBtn');
            const closeInfoBtnFooter = document.getElementById('closeInfoBtnFooter');
            const importDataBtn = document.getElementById('importDataBtn');
            const exportDataBtn = document.getElementById('exportDataBtn');
            const importFileInput = document.getElementById('importFileInput');
            const commentTooltip = document.getElementById('comment-tooltip');
            let confirmCallback = null;
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const globalSearchInput = document.getElementById('globalSearch');
            const globalSearchResults = document.getElementById('global-search-results');
            const tagFilterContainer = document.getElementById('tag-filter-container');


            // View Elements
            const viewTabs = document.querySelectorAll('.view-tab');
            const viewTitle = document.getElementById('viewTitle');
            const viewsContainer = document.getElementById('views');
            const kanbanView = document.getElementById('kanban-view');
            const listView = document.getElementById('list-view');
            const roadmapView = document.getElementById('roadmap-view');
            const ganttView = document.getElementById('gantt-view');
            const workloadView = document.getElementById('workload-view');
            const calendarView = document.getElementById('calendar-view');
            const dashboardView = document.getElementById('dashboard-view');
            let currentView = 'kanban';
            let activeTagFilter = null;
            let gantt, assigneePieChart, assigneeBarChart, burnDownChart;
            let calendarState = { year: new Date().getFullYear(), month: new Date().getMonth() };
            const viewTitles = {
                kanban: 'Kanban ploča', list: 'Lista zadataka', roadmap: 'Roadmap', gantt: 'Gantt Chart',
                workload: 'Opterećenje tima', calendar: 'Kalendar projekta', dashboard: 'Nadzorna ploča'
            };
            const statusLabels = { todo: 'Za obaviti', inprogress: 'U izradi', done: 'Gotovo' };


            // --- Sidebar Toggle ---
            const updateSidebarState = () => {
                const isCollapsed = sidebar.classList.contains('collapsed');
                localStorage.setItem('sidebarCollapsed', isCollapsed);
                const toggleIcon = document.getElementById('sidebarToggleIcon');

                if (toggleIcon) {
                    toggleIcon.classList.toggle('fa-chevron-left', !isCollapsed);
                    toggleIcon.classList.toggle('fa-chevron-right', isCollapsed);
                }
            };

            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                updateSidebarState();
            });

            if (localStorage.getItem('sidebarCollapsed') === 'true') {
                sidebar.classList.add('collapsed');
            }
            updateSidebarState();

            // --- Podaci ---
            let data = JSON.parse(localStorage.getItem('pmoData')) || {
                projects: [{ 
                    id: 1, name: 'Redizajn Web Stranice', 
                    tasks: [
                        { id: 1, title: 'Analiza tržišta', description: 'Istražiti konkurenciju i ciljanu publiku.', assignee: 'Ana Anić', startDate: '2025-10-20', endDate: '2025-10-25', status: 'done', priority: 'high', subtasks: [], dependencies: [], tags: ["#analiza", "#istraživanje"], comments: [ { text: 'Konkurencija koristi sličan pristup. Moramo biti inovativniji.', author: 'Ana Anić', timestamp: '2025-10-21T14:30:00.000Z' } ] },
                        { id: 2, title: 'Izrada wireframea', description: 'Definirati strukturu i layout stranice.', assignee: 'Ivan Ivić', startDate: '2025-10-22', endDate: '2025-10-28', status: 'inprogress', priority: 'medium', subtasks: [
                            {id: 1, text: 'Homepage wireframe', completed: true},
                            {id: 2, text: 'About Us wireframe', completed: false},
                            {id: 3, text: 'Contact page wireframe', completed: false}
                        ], dependencies: [1], tags: ["#dizajn", "#UX"], comments: [] },
                        { id: 3, title: 'Dizajn korisničkog sučelja', description: 'Kreirati vizualni identitet i komponente.', assignee: 'Ana Anić', startDate: '2025-10-25', endDate: '2025-11-05', status: 'inprogress', priority: 'high', subtasks: [], dependencies: [2], tags: ["#dizajn", "#UI"], comments: [] },
                        { id: 4, title: 'Frontend razvoj', description: 'Implementirati dizajn u HTML/CSS/JS.', assignee: 'Marko Markić', startDate: '2025-11-01', endDate: '2025-11-15', status: 'todo', priority: 'high', subtasks: [], dependencies: [3], tags: ["#razvoj", "#frontend"], comments: [] },
                        { id: 5, title: 'Backend integracija', description: 'Povezati frontend s CMS-om.', assignee: 'Petra Petrić', startDate: '2025-11-10', endDate: '2025-11-25', status: 'todo', priority: 'medium', subtasks: [], dependencies: [4], tags: ["#razvoj", "#backend"], comments: []},
                        { id: 6, title: 'Testiranje i ispravci', description: 'Osigurati funkcionalnost i responzivnost.', assignee: 'Ivan Ivić', startDate: '2025-11-26', endDate: '2025-11-30', status: 'todo', priority: 'low', subtasks: [], dependencies: [4, 5], tags: ["#testiranje", "#bug"], comments: [] }
                    ],
                    activityLog: []
                }],
                currentProjectId: 1
            };
            
            // --- Glavne funkcije ---
            const saveData = () => { localStorage.setItem('pmoData', JSON.stringify(data)); };
            const getCurrentProject = () => data.projects.find(p => p.id == data.currentProjectId);
            
            const findTaskByProjectAndId = (projectId, taskId) => {
                const project = data.projects.find(p => p.id == projectId);
                if (project) {
                    const task = (project.tasks || []).find(t => t.id == taskId);
                    // Return a copy to avoid direct mutation
                    return task ? {...task, projectId: project.id} : null;
                }
                return null;
            };

            const logActivity = (message, details = {}) => {
                const project = getCurrentProject();
                if (!project) return;
                if (!project.activityLog) {
                    project.activityLog = [];
                }
                project.activityLog.push({
                    message: message,
                    timestamp: new Date().toISOString(),
                    ...details
                });
                // Do not save here, will be saved by the calling function
            };
            
            // --- Funkcija za sortiranje zadataka ---
            const sortTasks = (tasks) => {
                const priorityValues = { high: 3, medium: 2, low: 1 };
                return [...tasks].sort((a, b) => {
                    // Sortiraj po prioritetu silazno (visok -> nizak)
                    const priorityA = priorityValues[a.priority] || 0;
                    const priorityB = priorityValues[b.priority] || 0;
                    if (priorityA !== priorityB) {
                        return priorityB - priorityA;
                    }

                    // Ako je prioritet isti, sortiraj po datumu završetka uzlazno (ranije -> kasnije)
                    const dateA = new Date(a.endDate);
                    const dateB = new Date(b.endDate);
                    return dateA - dateB;
                });
            };

            // --- Funkcije za prikaz ---
            const renderCurrentView = () => {
                renderTagFilter();
                const project = getCurrentProject();
                const containerIsEmpty = (html) => `<div class="text-center py-16 text-slate-500">${html}</div>`;
                if (!project && currentView !== 'roadmap') {
                    kanbanColumns.forEach(col => col.innerHTML = '');
                    listView.innerHTML = containerIsEmpty('Odaberite ili kreirajte novi projekt za početak.');
                    ganttView.innerHTML = containerIsEmpty('Nema odabranog projekta.');
                    workloadView.innerHTML = containerIsEmpty('Nema odabranog projekta.');
                    calendarView.innerHTML = containerIsEmpty('Nema odabranog projekta.');
                    dashboardView.innerHTML = containerIsEmpty('Nema odabranog projekta.');
                    return;
                }

                if (currentView === 'kanban') renderBoard();
                else if (currentView === 'list') renderTaskList();
                else if (currentView === 'roadmap') renderRoadmap();
                else if (currentView === 'gantt') renderTimeline();
                else if (currentView === 'workload') renderWorkload();
                else if (currentView === 'calendar') renderCalendar();
                else if (currentView === 'dashboard') renderDashboard();
            };

            const switchView = (viewName) => {
                currentView = viewName;
                viewTitle.textContent = viewTitles[viewName] || 'Upravljačka ploča';
                [kanbanView, listView, roadmapView, ganttView, workloadView, calendarView, dashboardView].forEach(v => v.classList.add('hidden'));
                document.getElementById(`${viewName}-view`).classList.remove('hidden');
                
                viewTabs.forEach(tab => {
                    const isCurrent = tab.id.startsWith(viewName);
                    tab.classList.toggle('bg-slate-700', isCurrent);
                    tab.classList.toggle('text-white', isCurrent);
                    tab.classList.toggle('text-slate-300', !isCurrent);
                });
                renderCurrentView();
            };

            // --- Funkcije za modal ---
            const openModal = (modal, content) => {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                setTimeout(() => { content.classList.remove('scale-95', 'opacity-0'); }, 10);
            };
            const closeModal = (modal, content) => {
                content.classList.add('scale-95', 'opacity-0');
                setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 300);
            };

             const renderSubtaskList = (subtasks = []) => {
                const subtaskList = document.getElementById('subtaskList');
                subtaskList.innerHTML = '';
                subtasks.forEach(subtask => {
                    const subtaskEl = document.createElement('div');
                    subtaskEl.className = 'flex items-center gap-3 p-2 bg-slate-50 rounded-md subtask-item';
                    subtaskEl.dataset.id = subtask.id;

                    subtaskEl.innerHTML = `
                        <input type="checkbox" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" ${subtask.completed ? 'checked' : ''}>
                        <label class="flex-grow text-sm text-slate-800">${subtask.text}</label>
                        <button type="button" class="delete-subtask-btn text-slate-400 hover:text-red-600">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                    subtaskList.appendChild(subtaskEl);
                });
            };

            const renderCommentsList = (comments = []) => {
                const listEl = document.getElementById('task-comments-list');
                if (!comments || comments.length === 0) {
                    listEl.innerHTML = `<p class="text-sm text-slate-500 text-center py-4">Nema komentara.</p>`;
                    return;
                }
                listEl.innerHTML = comments.map(comment => {
                    const commentDate = new Date(comment.timestamp);
                    const formattedDate = commentDate.toLocaleString('hr-HR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                    const canEdit = comment.author === 'Ja';

                    return `
                        <div class="text-sm comment-item" data-comment-id="${comment.timestamp}">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-semibold text-slate-700">${comment.author}</span>
                                <div class="flex items-center gap-3">
                                    <span class="text-xs text-slate-500">${formattedDate}</span>
                                    ${canEdit ? `
                                    <div class="comment-actions">
                                        <button class="edit-comment-btn text-slate-400 hover:text-indigo-600" title="Uredi"><i class="fas fa-pencil-alt fa-xs"></i></button>
                                        <button class="delete-comment-btn text-slate-400 hover:text-red-600" title="Obriši"><i class="fas fa-trash-alt fa-xs"></i></button>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="comment-content">
                                <p class="text-slate-600 bg-white p-2 rounded-md border">${comment.text}</p>
                            </div>
                        </div>
                    `;
                }).join('');
                listEl.scrollTop = listEl.scrollHeight;
            };
            
            const openTaskModal = (task = null, presetStatus = null) => {
                taskForm.reset();
                document.getElementById('taskPriority').value = 'medium';
                // Populate project select
                const projectSelect = document.getElementById('taskProjectSelect');
                const projectSelectWrapper = document.getElementById('taskProjectSelectWrapper');
                projectSelect.innerHTML = '';
                data.projects.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id; opt.textContent = p.name;
                    if (p.id == data.currentProjectId) opt.selected = true;
                    projectSelect.appendChild(opt);
                });

                if (task) {
                    modalTitle.textContent = 'Uredi zadatak';
                    document.getElementById('taskId').value = task.id;
                    document.getElementById('taskProjectId').value = task.projectId || getCurrentProject().id;
                    document.getElementById('taskTitle').value = task.title;
                    document.getElementById('taskDescription').value = task.description;
                    document.getElementById('taskAssignee').value = task.assignee;
                    document.getElementById('taskStartDate').value = task.startDate;
                    document.getElementById('taskEndDate').value = task.endDate;
                    document.getElementById('taskPriority').value = task.priority || 'medium';
                    projectSelectWrapper.classList.add('hidden');
                    renderSubtaskList(task.subtasks);
                    renderTagPills(task.tags || []);
                    renderCommentsList(task.comments);
                } else {
                    modalTitle.textContent = 'Novi zadatak';
                    document.getElementById('taskId').value = '';
                    projectSelectWrapper.classList.add('hidden');
                    renderSubtaskList([]);
                    renderTagPills([]);
                    renderCommentsList([]);
                }
                if (presetStatus) {
                    document.getElementById('taskStatusPreset').value = presetStatus;
                } else {
                    document.getElementById('taskStatusPreset').value = '';
                }

                // Populate dependencies
                const taskDependenciesSelect = document.getElementById('taskDependencies');
                taskDependenciesSelect.innerHTML = '';
                const projectForDependencies = data.projects.find(p => p.id == (task?.projectId || getCurrentProject().id));
                
                if (projectForDependencies && projectForDependencies.tasks) {
                    projectForDependencies.tasks.forEach(t => {
                        if (task && t.id == task.id) return; // Can't depend on itself
                        const option = document.createElement('option');
                        option.value = t.id;
                        option.textContent = `(#${t.id}) ${t.title}`;
                        if (task && task.dependencies && task.dependencies.includes(t.id)) {
                            option.selected = true;
                        }
                        taskDependenciesSelect.appendChild(option);
                    });
                }


                openModal(taskModal, taskModalContent);
            };
            
            const showConfirmModal = (title, message, onConfirm) => {
                confirmTitle.textContent = title;
                confirmMessage.innerHTML = message;
                confirmCallback = onConfirm;
                openModal(confirmModal, confirmModalContent);
            };
            
            // --- Tooltip za komentare ---
            const showCommentTooltip = (e, task) => {
                if (!task.comments || task.comments.length === 0) return;
                
                const latestComment = [...task.comments].pop();
                const commentDate = new Date(latestComment.timestamp);
                const formattedDate = commentDate.toLocaleString('hr-HR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });

                commentTooltip.innerHTML = `
                    <div class="font-semibold text-slate-300 mb-1 flex items-center"><i class="far fa-clock fa-xs mr-2"></i> ${formattedDate}</div>
                    <div class="pl-5">${latestComment.text}</div>
                `;

                // Position tooltip
                const tooltipRect = commentTooltip.getBoundingClientRect();
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;

                let left = e.pageX + 15;
                let top = e.pageY + 15;

                if (left + tooltipRect.width > viewportWidth) {
                    left = e.pageX - tooltipRect.width - 15;
                }
                if (top + tooltipRect.height > viewportHeight) {
                    top = e.pageY - tooltipRect.height - 15;
                }

                commentTooltip.style.left = `${left}px`;
                commentTooltip.style.top = `${top}px`;
                commentTooltip.classList.remove('hidden');
            };

            const hideCommentTooltip = () => {
                commentTooltip.classList.add('hidden');
            };

            // --- Funkcije za projekte ---
            const isProjectCompleted = (project) => {
                if (!project.tasks || project.tasks.length === 0) return false;
                return project.tasks.every(task => task.status === 'done');
            };

            // Funkcija za računanje radnih dana (bez vikenda)
            const getWorkingDaysBetween = (startDate, endDate) => {
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                // Postavi oba datuma na početak dana
                start.setHours(0, 0, 0, 0);
                end.setHours(0, 0, 0, 0);
                
                // Ako je krajnji datum prije početnog, vrati 0 (posebna logika za 'premašeno' će se koristiti drugdje)
                if (end < start) {
                    return 0;
                }

                let workingDays = 0;
                const current = new Date(start);
                
                while (current <= end) {
                    const dayOfWeek = current.getDay();
                    // 0 = nedjelja, 6 = subota - preskačemo ih
                    if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                        workingDays++;
                    }
                    current.setDate(current.getDate() + 1);
                }
                
                return workingDays;
            };

            // Pomocne funkcije za rokove
            const isOverdue = (endDateStr) => {
                const today = new Date(); today.setHours(0,0,0,0);
                const endDate = new Date(endDateStr + 'T00:00:00');
                return endDate < today;
            };
            const workingDaysUntil = (endDateStr) => {
                const today = new Date(); today.setHours(0,0,0,0);
                const end = new Date(endDateStr + 'T00:00:00');
                return getWorkingDaysBetween(today, end);
            };

            const renderProjects = () => {
                projectSelector.innerHTML = '';
                const hasProjects = data.projects.length > 0;
                [addTaskBtn, renameProjectBtn, deleteProjectBtn, exportExcelBtn, exportPdfBtn].forEach(btn => {
                    btn.disabled = !hasProjects;
                    btn.classList.toggle('opacity-50', !hasProjects);
                    btn.classList.toggle('cursor-not-allowed', !hasProjects);
                });

                // Sortiraj projekte - završeni projekti na dno
                const sortedProjects = [...data.projects].sort((a, b) => {
                    const aCompleted = isProjectCompleted(a);
                    const bCompleted = isProjectCompleted(b);
                    
                    // Ako su oba završena ili oba nezavršena, zadrži originalni redoslijed
                    if (aCompleted === bCompleted) return 0;
                    // Završeni projekti idu na dno
                    return aCompleted ? 1 : -1;
                });

                sortedProjects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id; 
                    option.textContent = project.name;
                    if (project.id == data.currentProjectId) option.selected = true;
                    
                    // Označi završene projekte zelenom bojom
                    if (isProjectCompleted(project)) {
                        option.style.color = '#16a34a'; // zelena boja
                        option.style.fontWeight = '500';
                    }
                    
                    projectSelector.appendChild(option);
                });
                 if (!hasProjects) {
                    const option = document.createElement('option');
                    option.textContent = 'Nema projekata';
                    option.disabled = true;
                    projectSelector.appendChild(option);
                }
            };
            const openProjectModal = (isNew = true) => {
                projectForm.reset();
                const project = getCurrentProject();
                document.getElementById('projectId').value = isNew ? '' : (project ? project.id : '');
                document.getElementById('projectName').value = isNew ? '' : (project ? project.name : '');
                projectModalTitle.textContent = isNew ? 'Novi projekt' : 'Preimenuj projekt';
                submitProjectBtn.textContent = isNew ? 'Kreiraj' : 'Spremi';
                openModal(projectModal, projectModalContent);
            };
            const handleProjectChange = (e) => {
                data.currentProjectId = parseInt(e.target.value);
                saveData();
                renderCurrentView();
            };
            const handleDeleteProject = () => {
                const project = getCurrentProject();
                if (!project) return;
                showConfirmModal(
                    'Obriši projekt',
                    `Jeste li sigurni da želite obrisati projekt "<b>${project.name}</b>"?`,
                    () => {
                        data.projects = data.projects.filter(p => p.id != data.currentProjectId);
                        data.currentProjectId = data.projects.length > 0 ? data.projects[0].id : null;
                        saveData();
                        renderProjects();
                        renderCurrentView();
                    }
                );
            };
            const handleProjectFormSubmit = (e) => {
                e.preventDefault();
                const projectName = document.getElementById('projectName').value.trim();
                const projectId = document.getElementById('projectId').value;
                if (projectName) {
                    if (projectId) {
                        const project = data.projects.find(p => p.id == projectId);
                        if (project) {
                             logActivity(`Projekt "${project.name}" je preimenovan u "${projectName}".`);
                             project.name = projectName;
                        }
                    } else {
                        const newId = data.projects.length > 0 ? Math.max(...data.projects.map(p => p.id)) + 1 : 1;
                        data.projects.push({ id: newId, name: projectName, tasks: [], activityLog: [] });
                        data.currentProjectId = newId;
                        logActivity(`Kreiran je novi projekt "${projectName}".`);
                    }
                    saveData();
                    renderProjects();
                    renderCurrentView();
                    closeModal(projectModal, projectModalContent);
                }
            };
            
            // --- Funkcije za zadatke ---
            const createTaskCard = (task) => {
                const card = document.createElement('div');
                card.setAttribute('draggable', 'true');
                card.dataset.id = task.id;
                card.dataset.hasComments = task.comments && task.comments.length > 0;

                const priorities = {
                    high: { border: 'border-l-red-500', pill: 'bg-red-100 text-red-800', label: 'Visok' },
                    medium: { border: 'border-l-amber-500', pill: 'bg-amber-100 text-amber-800', label: 'Srednji' },
                    low: { border: 'border-l-emerald-500', pill: 'bg-emerald-100 text-emerald-800', label: 'Nizak' }
                };
                const priorityInfo = priorities[task.priority] || priorities.medium;
                const priorityPillHtml = `<span class="text-xs font-semibold px-2 py-0.5 rounded-full ${priorityInfo.pill}">${priorityInfo.label}</span>`;

                const today = new Date(); today.setHours(0, 0, 0, 0);
                const endDate = new Date(task.endDate + 'T00:00:00');
                
                let deadlineHtml = '';
                let cardBgClass = 'bg-white';
                let hoverBgClass = 'hover:bg-slate-50';

                if (task.status !== 'done') {
                    const overdue = isOverdue(task.endDate);
                    const workingDays = workingDaysUntil(task.endDate);
                    if (overdue) {
                        deadlineHtml = `<span class="text-xs font-semibold text-red-600 flex items-center"><i class="fas fa-exclamation-circle mr-1.5"></i>Rok premašen</span>`;
                        cardBgClass = 'bg-red-50';
                        hoverBgClass = 'hover:bg-red-100';
                    } else if (workingDays <= 3) {
                        deadlineHtml = `<span class="text-xs font-semibold text-amber-600 flex items-center"><i class="fas fa-hourglass-half mr-1.5"></i>Rok ističe uskoro</span>`;
                        cardBgClass = 'bg-amber-50';
                        hoverBgClass = 'hover:bg-amber-100';
                    }
                }
                
                let subtaskHtml = '';
                if (task.subtasks && task.subtasks.length > 0) {
                    const completed = task.subtasks.filter(st => st.completed).length;
                    const total = task.subtasks.length;
                    const progress = total > 0 ? (completed / total) * 100 : 0;
                    subtaskHtml = `
                        <div class="mt-3">
                            <div class="flex justify-between items-center text-xs text-slate-500 mb-1">
                                <span class="font-semibold"><i class="fas fa-check-square mr-1.5"></i>Podzadaci</span>
                                <span>${completed}/${total}</span>
                            </div>
                            <div class="w-full bg-slate-200 rounded-full h-1.5">
                                <div class="bg-indigo-500 h-1.5 rounded-full" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    `;
                }

                let tagsHtml = '';
                if (task.tags && task.tags.length > 0) {
                    tagsHtml = `<div class="mt-3 flex flex-wrap gap-2">
                        ${task.tags.map(tag => `<span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-blue-100 text-blue-800">${tag}</span>`).join('')}
                    </div>`;
                }

                card.className = `task-card p-4 rounded-lg shadow-sm border ${cardBgClass} ${hoverBgClass} ${priorityInfo.border} border-l-4`;
                const assigneeInitial = task.assignee ? task.assignee.charAt(0).toUpperCase() : '?';

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-semibold text-slate-800 pr-2">${task.title}</h4>
                        <div class="relative">
                            <button class="status-menu-toggle text-slate-400 hover:text-indigo-600 w-7 h-7 rounded-full flex items-center justify-center hover:bg-slate-100" data-id="${task.id}" title="Opcije">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                            <div id="status-menu-${task.id}" class="status-menu hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">
                                <div class="py-1" role="menu" aria-orientation="vertical">
                                    <a href="#" class="edit-btn block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100" data-id="${task.id}"><i class="fas fa-edit fa-fw mr-2"></i>Uredi</a>
                                    <a href="#" class="delete-btn block px-4 py-2 text-sm text-red-600 hover:bg-red-50" data-id="${task.id}"><i class="fas fa-trash fa-fw mr-2"></i>Obriši</a>
                                    <div class="border-t my-1"></div>
                                    <p class="px-4 pt-1 pb-1 text-xs text-slate-400">Premjesti u:</p>
                                    ${['todo', 'inprogress', 'done'].filter(s => s !== task.status).map(s => `
                                        <a href="#" class="move-task-btn block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100" role="menuitem" data-new-status="${s}" data-id="${task.id}">${statusLabels[s]}</a>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    <p class="text-sm text-slate-600 my-2">${task.description.substring(0, 100)}${task.description.length > 100 ? '...' : ''}</p>
                    ${subtaskHtml}
                    ${tagsHtml}
                    <div class="mt-4 pt-3 border-t border-slate-100 flex justify-between items-center gap-2 flex-wrap">
                        <div class="flex items-center gap-2">
                            <div title="${task.assignee || 'Nedodijeljeno'}" class="h-7 w-7 rounded-full bg-indigo-100 text-indigo-600 font-bold text-sm flex items-center justify-center flex-shrink-0">${assigneeInitial}</div>
                            ${priorityPillHtml}
                        </div>
                        <div class="flex items-center gap-2 text-xs">
                            ${deadlineHtml}
                             <span class="text-slate-500 font-medium whitespace-nowrap flex items-center">
                                ${card.dataset.hasComments === 'true' ? '<i class="far fa-comment-dots mr-3" title="Sadrži komentar"></i>' : ''}
                                <i class="far fa-calendar-check mr-1.5"></i>${task.endDate}
                            </span>
                        </div>
                    </div>
                `;
                card.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', task.id);
                    setTimeout(() => card.classList.add('dragging'), 0);
                });
                card.addEventListener('dragend', () => card.classList.remove('dragging'));
                card.addEventListener('click', (e) => {
                    if (e.target.closest('.status-menu-toggle') || e.target.closest('.status-menu')) return;
                    openTaskModal(task);
                });
                // Comment tooltip listeners
                card.addEventListener('mouseenter', (e) => showCommentTooltip(e, task));
                card.addEventListener('mouseleave', hideCommentTooltip);

                return card;
            };

            const renderBoard = () => {
                const project = getCurrentProject();
                const tasks = activeTagFilter ? (project.tasks || []).filter(t => t.tags && t.tags.includes(activeTagFilter)) : (project.tasks || []);
                
                kanbanColumns.forEach(col => col.innerHTML = '');

                const tasksByStatus = tasks.reduce((acc, task) => {
                    acc[task.status] = acc[task.status] || [];
                    acc[task.status].push(task);
                    return acc;
                }, { todo: [], inprogress: [], done: [] });

                Object.keys(tasksByStatus).forEach(status => {
                    const sortedTasks = sortTasks(tasksByStatus[status]);
                    const column = document.querySelector(`.kanban-column-body[data-status="${status}"]`);
                    if (column) {
                        sortedTasks.forEach(task => {
                            const card = createTaskCard(task);
                            column.appendChild(card);
                        });
                    }
                });
            };
            
            const renderTaskList = () => {
                const project = getCurrentProject();
                listView.innerHTML = ''; 
                
                const tasks = activeTagFilter ? (project.tasks || []).filter(t => t.tags && t.tags.includes(activeTagFilter)) : (project.tasks || []);
                
                if (!tasks || tasks.length === 0) {
                    listView.innerHTML = '<div class="text-center py-16 text-slate-500">Nema zadataka za prikaz.</div>';
                    return;
                }
                
                const listCategoryState = JSON.parse(localStorage.getItem('listCategoryState')) || {};

                const categories = [
                    { status: 'done', title: 'Gotovo', icon: 'fa-check-double', textColor: 'text-emerald-800', bgColor: 'bg-emerald-100', borderColor: 'border-emerald-200' },
                    { status: 'inprogress', title: 'U izradi', icon: 'fa-person-digging', textColor: 'text-amber-800', bgColor: 'bg-amber-100', borderColor: 'border-amber-200' },
                    { status: 'todo', title: 'Za obaviti', icon: 'fa-list-check', textColor: 'text-red-800', bgColor: 'bg-red-100', borderColor: 'border-red-200' },
                ];

                categories.forEach(category => {
                    let tasksInCategory = tasks.filter(t => t.status === category.status);
                    if (tasksInCategory.length === 0 && activeTagFilter) return; // Hide empty categories when filtering
                    
                    tasksInCategory = sortTasks(tasksInCategory);

                    const isCollapsed = listCategoryState[category.status] || false;

                    const categoryWrapper = document.createElement('div');
                    categoryWrapper.className = 'mb-6';
                    
                    const headerHtml = `
                        <div class="flex items-center justify-between p-3 rounded-t-lg cursor-pointer ${category.bgColor} ${category.textColor} border-b-2 ${category.borderColor} category-toggle-btn" data-status="${category.status}">
                            <div class="flex items-center">
                                <i class="fas ${isCollapsed ? 'fa-chevron-right' : 'fa-chevron-down'} fa-fw w-5 transition-transform duration-300"></i>
                                <i class="fas ${category.icon} fa-fw mx-3"></i>
                                <h3 class="font-bold text-lg">${category.title} (${tasksInCategory.length})</h3>
                            </div>
                            <button class="category-add-btn bg-white/50 hover:bg-white/80 rounded-full w-8 h-8 flex items-center justify-center" data-status="${category.status}" title="Dodaj zadatak u '${category.title}'">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    `;

                    let tasksHtml = `<div class="task-list-container ${isCollapsed ? 'hidden' : ''} border border-t-0 border-slate-200 rounded-b-lg overflow-hidden">`;

                    if (tasksInCategory.length > 0) {
                        const tableHeader = `
                        <table class="w-full text-sm text-left text-slate-500 list-view-table">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-50 sr-only">
                                <tr>
                                    <th scope="col" class="px-2 py-3 w-12">Status</th>
                                    <th scope="col" class="px-4 py-3">Naziv</th>
                                    <th scope="col" class="px-4 py-3">Zadužen</th>
                                    <th scope="col" class="px-4 py-3">Rok</th>
                                    <th scope="col" class="px-4 py-3">Prioritet</th>
                                    <th scope="col" class="px-2 py-3 w-16">Akcije</th>
                                </tr>
                            </thead>
                            <tbody>`;

                        const tableRows = tasksInCategory.map(task => {
                            const priorities = {
                                high: { label: 'Visok', text: 'text-red-800', bg: 'bg-red-100' },
                                medium: { label: 'Srednji', text: 'text-amber-800', bg: 'bg-amber-100' },
                                low: { label: 'Nizak', text: 'text-emerald-800', bg: 'bg-emerald-100' }
                            };
                            const priorityInfo = priorities[task.priority] || priorities.medium;

                            const statusIcons = {
                                todo: { icon: 'fa-circle', color: 'text-slate-400 hover:text-red-500'},
                                inprogress: { icon: 'fa-circle-half-stroke', color: 'text-amber-500'},
                                done: { icon: 'fa-check-circle', color: 'text-emerald-500'}
                            };
                            const statusIconInfo = statusIcons[task.status];
                             let subtaskInfo = '';
                            if(task.subtasks && task.subtasks.length > 0) {
                                const completed = task.subtasks.filter(st => st.completed).length;
                                subtaskInfo = `<span class="text-xs font-semibold text-slate-500 ml-2">(${completed}/${task.subtasks.length})</span>`;
                            }
                             let tagsInfo = '';
                            if(task.tags && task.tags.length > 0) {
                                tagsInfo = `<div class="flex flex-wrap gap-1 mt-1">
                                    ${task.tags.map(tag => `<span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-blue-100 text-blue-800">${tag}</span>`).join('')}
                                </div>`;
                            }


                            return `
                                <tr class="bg-white border-b border-slate-200 hover:bg-slate-50" data-task-id="${task.id}">
                                    <td class="px-2 py-4 text-center relative">
                                        <button class="task-status-toggle ${statusIconInfo.color}" data-id="${task.id}" title="Promijeni status">
                                            <i class="fas ${statusIconInfo.icon} fa-lg"></i>
                                        </button>
                                        <div id="list-status-menu-${task.id}" class="list-status-menu hidden absolute left-10 top-1/2 -translate-y-1/2 mt-0 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-20">
                                            <div class="py-1" role="menu">
                                                <p class="px-4 pt-1 pb-1 text-xs text-slate-400">Promijeni u:</p>
                                                ${['todo', 'inprogress', 'done'].filter(s => s !== task.status).map(s => `
                                                    <a href="#" class="list-move-task-btn block px-4 py-2 text-sm text-slate-700 hover:bg-slate-100" role="menuitem" data-new-status="${s}" data-id="${task.id}">${statusLabels[s]}</a>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-4 font-medium text-slate-900">
                                        <div>
                                            <a href="#" class="task-title-link hover:underline" data-id="${task.id}">${task.title}</a> 
                                            ${task.comments && task.comments.length > 0 ? `<i class="far fa-comment-dots text-slate-400 ml-2" title="Sadrži komentar"></i>` : ''}
                                            ${subtaskInfo}
                                        </div>
                                        ${tagsInfo}
                                    </td>
                                    <td class="px-4 py-4">${task.assignee}</td>
                                    <td class="px-4 py-4">${task.endDate}</td>
                                    <td class="px-4 py-4"><span class="text-xs font-semibold px-2.5 py-0.5 rounded-full ${priorityInfo.bg} ${priorityInfo.text}">${priorityInfo.label}</span></td>
                                    <td class="px-2 py-4 text-right">
                                        <button class="delete-btn text-slate-500 hover:text-red-600 p-2" data-id="${task.id}" title="Obriši"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `;
                        }).join('');

                        tasksHtml += tableHeader + tableRows + `</tbody></table>`;
                    } else {
                        tasksHtml += `<div class="text-center p-8 text-sm text-slate-500">Nema zadataka u ovoj kategoriji.</div>`;
                    }
                    tasksHtml += `</div>`;
                    categoryWrapper.innerHTML = headerHtml + tasksHtml;
                    listView.appendChild(categoryWrapper);
                });
            };
            
            const renderRoadmap = () => {
                roadmapView.innerHTML = `
                    <div id="roadmap-container" class="space-y-4">
                        <div id="roadmap-header" class="grid grid-cols-8 text-center font-bold text-sm text-slate-600 sticky top-0 bg-white/70 backdrop-blur-sm z-10 py-2 rounded-t-lg">
                            <!-- Quarters will be generated here -->
                        </div>
                        <div id="roadmap-timeline" class="relative overflow-x-auto">
                            <!-- Projects will be generated here -->
                        </div>
                    </div>
                `;

                if (data.projects.length === 0) {
                    roadmapView.innerHTML = '<div class="text-center py-16 text-slate-500">Nema projekata za prikaz.</div>';
                    return;
                }

                const today = new Date();
                const currentYear = today.getFullYear();
                const years = [currentYear, currentYear + 1];
                let totalDays = 0;
                let quarterHeaders = '';
                
                const headerContainer = document.getElementById('roadmap-header');
                const timelineContainer = document.getElementById('roadmap-timeline');

                years.forEach(year => {
                    for (let q = 1; q <= 4; q++) {
                        const daysInQuarter = (new Date(year, q * 3, 0)).getDate();
                        quarterHeaders += `<div class="col-span-1 border-r border-slate-200 py-2">Q${q} ${year}</div>`;
                    }
                });
                // We show 8 quarters (2 years)
                totalDays = (new Date(currentYear + 2, 0, 0) - new Date(currentYear, 0, 1)) / (1000 * 60 * 60 * 24);
                headerContainer.innerHTML = quarterHeaders;
                timelineContainer.style.height = `${data.projects.length * 5}rem`;

                const palette = [
                    { bg: 'bg-indigo-200', fill: 'bg-indigo-500' },
                    { bg: 'bg-emerald-200', fill: 'bg-emerald-500' },
                    { bg: 'bg-amber-200', fill: 'bg-amber-500' },
                    { bg: 'bg-sky-200', fill: 'bg-sky-500' },
                    { bg: 'bg-pink-200', fill: 'bg-pink-500' },
                    { bg: 'bg-purple-200', fill: 'bg-purple-500' },
                    { bg: 'bg-teal-200', fill: 'bg-teal-500' }
                ];

                let projectsHtml = '';
                data.projects.forEach((project, index) => {
                    const tasks = project.tasks || [];
                    if (tasks.length === 0) return;

                    const startDates = tasks.map(t => new Date(t.startDate));
                    const endDates = tasks.map(t => new Date(t.endDate));
                    const projectStart = new Date(Math.min(...startDates));
                    const projectEnd = new Date(Math.max(...endDates));
                    
                    const completedTasks = tasks.filter(t => t.status === 'done').length;
                    const progress = tasks.length > 0 ? (completedTasks / tasks.length) * 100 : 0;

                    const timelineStart = new Date(currentYear, 0, 1);
                    const offsetDays = (projectStart - timelineStart) / (1000 * 60 * 60 * 24);
                    const durationDays = (projectEnd - projectStart) / (1000 * 60 * 60 * 24);
                    
                    const left = (offsetDays / totalDays) * 100;
                    const width = (durationDays / totalDays) * 100;
                    const color = palette[index % palette.length];

                    projectsHtml += `
                        <div class="absolute w-full" style="top: ${index * 5}rem;">
                           <div class="flex items-center h-20">
                                <div class="w-48 px-4 font-bold text-slate-700 truncate">${project.name}</div>
                                <div class="flex-1 h-full border-l border-slate-200 relative">
                                    <div class="roadmap-bar-wrapper absolute h-full flex items-center cursor-pointer" style="left: ${left}%; width: ${width}%" data-project-id="${project.id}">
                                        <div class="h-10 w-full ${color.bg} rounded-lg relative overflow-hidden">
                                             <div class="h-full ${color.fill}" style="width: ${progress}%"></div>
                                             <span class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white">${Math.round(progress)}%</span>
                                        </div>
                                    </div>
                                </div>
                           </div>
                        </div>
                    `;
                });
                timelineContainer.innerHTML = projectsHtml;

            };


            const renderTimeline = () => {
                 ganttView.innerHTML = '<svg id="gantt-chart"></svg>'; 
                const project = getCurrentProject();
                const tasks = activeTagFilter ? (project.tasks || []).filter(t => t.tags && t.tags.includes(activeTagFilter)) : (project.tasks || []);

                if (!tasks || tasks.length === 0) {
                    ganttView.innerHTML = '<div class="text-center py-16 text-slate-500">Nema zadataka za prikaz.</div>';
                    return;
                }
                const ganttTasks = tasks.map(task => {
                    let progress = 0;
                    // Izračunaj napredak na temelju podzadataka ako postoje
                    if (task.subtasks && task.subtasks.length > 0) {
                        const completedSubtasks = task.subtasks.filter(st => st.completed).length;
                        progress = (completedSubtasks / task.subtasks.length) * 100;
                    } else if (task.status === 'done') {
                        progress = 100;
                    } else if (task.status === 'inprogress') {
                        progress = 50; // Zadani napredak za zadatke "u izradi" bez podzadataka
                    }

                    return {
                        id: String(task.id),
                        name: task.title,
                        start: task.startDate,
                        end: task.endDate,
                        progress: progress,
                        assignee: task.assignee,
                        dependencies: (task.dependencies || []).join(','),
                        custom_class: `gantt-status-${task.status}`, // Klasa temeljena na statusu
                        status: task.status
                    };
                });
                gantt = new Gantt("#gantt-chart", ganttTasks, {
                    header_height: 50, bar_height: 24, bar_corner_radius: 5, view_mode: 'Day',
                    custom_popup_html: task => {
                        const statusLabel = statusLabels[task.status] || 'Nepoznato';
                        return `
                        <div class="gantt-popup-container bg-white rounded-xl shadow-2xl border border-slate-200 w-64 text-slate-700" style="font-family: 'Inter', sans-serif;">
                            <div class="p-4 border-b border-slate-100">
                                <h4 class="font-bold text-base text-slate-800">${task.name}</h4>
                            </div>
                            <div class="p-4 space-y-3 text-sm">
                                <div class="flex items-start">
                                    <i class="fas fa-user-circle fa-fw w-5 text-slate-400 mt-0.5 mr-3"></i>
                                    <div>
                                        <p class="text-xs text-slate-500">Zadužen/a</p>
                                        <p class="font-semibold">${task.assignee || 'Nedodijeljeno'}</p>
                                    </div>
                                </div>
                                <div class="flex items-start">
                                    <i class="fas fa-flag fa-fw w-5 text-slate-400 mt-0.5 mr-3"></i>
                                    <div>
                                        <p class="text-xs text-slate-500">Status</p>
                                        <p class="font-semibold">${statusLabel}</p>
                                    </div>
                                </div>
                                <div class="flex items-start">
                                    <i class="far fa-calendar fa-fw w-5 text-slate-400 mt-0.5 mr-3"></i>
                                    <div>
                                        <p class="text-xs text-slate-500">Period</p>
                                        <p class="font-semibold">${new Date(task.start).toLocaleDateString('hr-HR')} - ${new Date(task.end).toLocaleDateString('hr-HR')}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="p-3 bg-slate-50 rounded-b-xl gantt-popup-workload-link cursor-pointer hover:bg-slate-100 transition-colors" data-assignee="${task.assignee || ''}">
                                <p class="text-indigo-600 text-center text-sm font-semibold">Prikaži opterećenje <i class="fas fa-arrow-right fa-xs ml-1"></i></p>
                            </div>
                        </div>
                        `;
                    }
                });
            };

            const renderCalendar = () => {
                 calendarView.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <button id="prevMonthBtn" class="text-slate-600 hover:text-indigo-600 px-3 py-1 rounded-md border border-slate-300 bg-white shadow-sm text-sm"><i class="fas fa-chevron-left"></i></button>
                            <button id="nextMonthBtn" class="text-slate-600 hover:text-indigo-600 px-3 py-1 rounded-md border border-slate-300 bg-white shadow-sm text-sm"><i class="fas fa-chevron-right"></i></button>
                            <span id="calendarMonthLabel" class="text-slate-800 font-semibold text-lg ml-2"></span>
                        </div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-px bg-slate-200 border border-slate-200 rounded-lg overflow-hidden"></div>
                 `;

                const grid = document.getElementById('calendar-grid');
                const monthLabel = document.getElementById('calendarMonthLabel');
                const { year, month } = calendarState; // month 0-11
                const firstDay = new Date(year, month, 1);
                const startWeekday = (firstDay.getDay() + 6) % 7; // Monday=0
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                monthLabel.textContent = firstDay.toLocaleDateString('hr-HR', { month: 'long', year: 'numeric' });

                const weekdays = ['Pon','Uto','Sri','Čet','Pet','Sub','Ned'];
                weekdays.forEach(w => grid.innerHTML += `<div class="text-xs font-semibold text-slate-500 uppercase p-2 bg-slate-50 text-center">${w}</div>`);

                const projectColors = () => {
                    const palette = ['bg-indigo-100 text-indigo-700','bg-emerald-100 text-emerald-700','bg-amber-100 text-amber-700','bg-sky-100 text-sky-700','bg-pink-100 text-pink-700','bg-purple-100 text-purple-700','bg-teal-100 text-teal-700'];
                    const map = new Map();
                    data.projects.forEach((p, idx) => map.set(p.id, palette[idx % palette.length]));
                    return map;
                };
                const colorMap = projectColors();
                
                const tasksByDate = {};
                data.projects.forEach(p => {
                    (p.tasks || []).forEach(t => {
                        const d = t.endDate;
                        if (!d) return;
                        if (!tasksByDate[d]) tasksByDate[d] = [];
                        tasksByDate[d].push({ ...t, projectId: p.id, projectName: p.name });
                    });
                });
                
                let dayCells = '';
                for (let i = 0; i < startWeekday; i++) dayCells += `<div class="min-h-[120px] bg-slate-50"></div>`;

                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                    const items = (tasksByDate[dateStr] || []).sort((a,b) => a.projectId - b.projectId);
                    const itemsHtml = items.map(item => `
                        <div class="text-xs px-2 py-1 rounded ${colorMap.get(item.projectId)} cursor-pointer truncate" title="${item.title} (${item.projectName})" data-task-id="${item.id}" data-project-id="${item.projectId}">
                            ${item.title}
                        </div>
                    `).join('');
                    
                    dayCells += `
                        <div class="relative min-h-[120px] bg-white p-2 group">
                            <span class="font-semibold text-slate-700">${day}</span>
                            <button class="add-task-day absolute top-1 right-1 hidden group-hover:block text-indigo-600 hover:text-indigo-800 w-6 h-6 rounded-full bg-indigo-100" title="Dodaj zadatak" data-date="${dateStr}"><i class="fas fa-plus fa-xs"></i></button>
                            <div class="mt-2 space-y-1">${itemsHtml}</div>
                        </div>
                    `;
                }
                grid.innerHTML += dayCells;
                
                document.getElementById('prevMonthBtn').onclick = () => {
                    const d = new Date(calendarState.year, calendarState.month - 1, 1);
                    calendarState = { year: d.getFullYear(), month: d.getMonth() };
                    renderCalendar();
                };
                document.getElementById('nextMonthBtn').onclick = () => {
                    const d = new Date(calendarState.year, calendarState.month + 1, 1);
                    calendarState = { year: d.getFullYear(), month: d.getMonth() };
                    renderCalendar();
                };
            };
            
            const renderWorkload = () => {
                 workloadView.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                        <div>
                             <h2 class="text-xl font-bold text-slate-700">Opterećenje članova tima</h2>
                             <p class="text-sm text-slate-500 mt-1">Prikaz zaduženja za sve članove na trenutnom projektu.</p>
                        </div>
                        <div class="relative w-full sm:w-64 workload-search-container">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-slate-400"></i></div>
                            <input type="text" id="workloadSearch" placeholder="Pretraži članove..." class="block w-full pl-10 pr-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div id="workload-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                 `;
                const container = document.getElementById('workload-container');
                const searchInput = document.getElementById('workloadSearch');

                const project = getCurrentProject();
                const currentProjectTasks = activeTagFilter ? 
                    (project.tasks || []).filter(t => t.tags && t.tags.includes(activeTagFilter)) : 
                    (project.tasks || []);

                if (!project || currentProjectTasks.length === 0) {
                    container.innerHTML = '<div class="text-center py-16 text-slate-500 col-span-full">Nema članova tima na ovom projektu.</div>';
                    searchInput.disabled = true;
                    return;
                }
                
                // Članovi tima samo iz trenutnog projekta
                const teamMembers = [...new Set(currentProjectTasks.map(task => task.assignee || 'Nedodijeljeno').filter(Boolean))].sort();

                const displayWorkloadCards = (filter = '') => {
                    container.innerHTML = '';
                    const lowercasedFilter = filter.toLowerCase().trim();
                    const filteredMembers = teamMembers.filter(member => member.toLowerCase().includes(lowercasedFilter));

                    if (filteredMembers.length === 0) {
                        container.innerHTML = '<p class="text-center text-slate-500 p-8 col-span-full">Nema rezultata.</p>';
                        return;
                    }

                    filteredMembers.forEach(assignee => {
                        const stats = { todo: 0, inprogress: 0, done: 0 };
                        const allTasksForMember = [];
                        const seenTaskKeys = new Set(); // Sprječavanje duplikata po projektu i ID-u
                        
                        // Zadaci iz svih projekata za ovog korisnika
                        data.projects.forEach(p => {
                            (p.tasks || []).forEach(task => {
                                if ((task.assignee || 'Nedodijeljeno') === assignee) {
                                    // Provjeri da li je zadatak već prikazan (po ključu projektId:taskId)
                                    const uniqueKey = `${p.id}:${task.id}`;
                                    if (!seenTaskKeys.has(uniqueKey)) {
                                        seenTaskKeys.add(uniqueKey);
                                        allTasksForMember.push({...task, projectName: p.name, projectId: p.id});
                                        // Brojimo sve zadatke (uključujući done)
                                        if (stats[task.status] !== undefined) {
                                            stats[task.status]++;
                                        }
                                    }
                                }
                            });
                        });
                        
                        // Debug: ispisujemo informacije o zadacima
                        console.log(`Korisnik: ${assignee}`);
                        console.log(`Zadaci:`, allTasksForMember.map(t => ({id: t.id, title: t.title, status: t.status, project: t.projectName})));
                        console.log(`Stats:`, stats);
                        
                        const totalActive = stats.todo + stats.inprogress;

                        const card = document.createElement('div');
                        card.className = 'bg-white p-5 rounded-xl border border-slate-200 shadow-sm';
                        card.innerHTML = `
                            <div class="flex items-center mb-4">
                                <div class="h-10 w-10 rounded-full bg-indigo-100 text-indigo-600 font-bold text-lg flex items-center justify-center mr-4">${assignee.charAt(0)}</div>
                                <div>
                                    <h3 class="font-bold text-lg text-slate-800">${assignee}</h3>
                                    <p class="text-sm text-slate-500">${totalActive} aktivnih zadataka</p>
                                </div>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between items-center text-red-600"><span><i class="fas fa-list-check fa-fw mr-2"></i>Za obaviti</span><span class="font-mono font-semibold bg-red-100 px-2 py-0.5 rounded">${stats.todo}</span></div>
                                <div class="flex justify-between items-center text-amber-600"><span><i class="fas fa-person-digging fa-fw mr-2"></i>U izradi</span><span class="font-mono font-semibold bg-amber-100 px-2 py-0.5 rounded">${stats.inprogress}</span></div>
                                <div class="flex justify-between items-center text-emerald-600"><span><i class="fas fa-check-double fa-fw mr-2"></i>Gotovo</span><span class="font-mono font-semibold bg-emerald-100 px-2 py-0.5 rounded">${stats.done}</span></div>
                            </div>
                            <div class="mt-4 pt-4 border-t">
                                <h4 class="font-semibold text-sm mb-2 text-slate-600">Aktivni zadaci:</h4>
                                <div class="space-y-2 workload-tasks-list pr-2">
                                ${allTasksForMember.filter(t => t.status !== 'done').map(t => `
                                    <div class="workload-task-item text-xs p-2 rounded bg-slate-100 cursor-pointer hover:bg-slate-200 transition-colors" data-task-id="${t.id}" data-project-id="${t.projectId}">
                                        <p class="font-medium text-slate-800 pointer-events-none">${t.title}</p>
                                        <p class="text-slate-500 pointer-events-none">${t.projectName} &bull; Rok: ${t.endDate}</p>
                                    </div>
                                `).join('')}
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                };
                
                searchInput.addEventListener('input', () => displayWorkloadCards(searchInput.value));
                displayWorkloadCards();
            };
            
            const formatTimeAgo = (timestamp) => {
                const now = new Date();
                const seconds = Math.floor((now - new Date(timestamp)) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return `prije ${Math.floor(interval)} god.`;
                interval = seconds / 2592000;
                if (interval > 1) return `prije ${Math.floor(interval)} mj.`;
                interval = seconds / 86400;
                if (interval > 1) return `prije ${Math.floor(interval)} d.`;
                interval = seconds / 3600;
                if (interval > 1) return `prije ${Math.floor(interval)} h`;
                interval = seconds / 60;
                if (interval > 1) return `prije ${Math.floor(interval)} min.`;
                return `upravo sada`;
            };

            // --- Notifikacije za rokove ---
            const notificationStorageKey = 'pmoDeadlineNotifications';
            const getNotificationState = () => {
                try {
                    return JSON.parse(localStorage.getItem(notificationStorageKey)) || {};
                } catch (_) {
                    return {};
                }
            };
            const saveNotificationState = (state) => {
                localStorage.setItem(notificationStorageKey, JSON.stringify(state));
            };
            const markNotified = (taskGlobalKey, type) => {
                const state = getNotificationState();
                if (!state[taskGlobalKey]) state[taskGlobalKey] = {};
                state[taskGlobalKey][type] = new Date().toISOString();
                saveNotificationState(state);
            };
            const wasNotified = (taskGlobalKey, type) => {
                const state = getNotificationState();
                return Boolean(state[taskGlobalKey] && state[taskGlobalKey][type]);
            };
            const requestNotificationPermissionIfNeeded = async () => {
                if (!('Notification' in window)) return false;
                if (Notification.permission === 'granted') return true;
                if (Notification.permission !== 'denied') {
                    try {
                        const perm = await Notification.requestPermission();
                        return perm === 'granted';
                    } catch (_) {
                        return false;
                    }
                }
                return false;
            };
            const sendBrowserNotification = (title, body) => {
                try {
                    if (!('Notification' in window)) return;
                    if (Notification.permission !== 'granted') return;
                    const n = new Notification(title, { body });
                    n.onclick = () => {
                        window.focus();
                    };
                } catch (err) {
                    console.warn('Notification error:', err);
                }
            };
            const checkAndNotifyDeadlines = () => {
                // Provjeri sve projekte i zadatke
                const today = new Date();
                today.setHours(0,0,0,0);
                (data.projects || []).forEach(project => {
                    (project.tasks || []).forEach(task => {
                        if (!task || task.status === 'done' || !task.endDate) return;
                        const overdue = isOverdue(task.endDate);
                        const workingDays = workingDaysUntil(task.endDate);
                        // Globalni ključ zadatka (projekt#task)
                        const taskKey = `${project.id}#${task.id}`;
                        if (overdue) {
                            if (!wasNotified(taskKey, 'overdue')) {
                                sendBrowserNotification('Rok premašen', `${task.title} (zadužen: ${task.assignee || 'N/A'})`);
                                markNotified(taskKey, 'overdue');
                                logActivity(`Zadatku "${task.title}" je istekao rok.`, { taskId: task.id });
                                saveData();
                            }
                        } else if (workingDays <= 3) {
                            if (!wasNotified(taskKey, 'dueSoon')) {
                                const dani = workingDays === 0 ? 'danas' : `za ${workingDays} rad. dana`;
                                sendBrowserNotification('Rok ističe uskoro', `${task.title} (${dani})`);
                                markNotified(taskKey, 'dueSoon');
                                logActivity(`Zadatku "${task.title}" uskoro istječe rok (${dani}).`, { taskId: task.id });
                                saveData();
                            }
                        }
                    });
                });
            };

            const renderDashboard = () => {
                const project = getCurrentProject();
                const tasks = activeTagFilter ? (project.tasks || []).filter(t => t.tags && t.tags.includes(activeTagFilter)) : (project.tasks || []);
                
                const dashboardContent = `
                    <!-- Stat Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div id="stat-card-todo" class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center cursor-pointer hover:shadow-lg hover:border-indigo-400 transition-all duration-300">
                            <div class="p-4 bg-red-100 rounded-lg mr-5"><i class="fas fa-list-check text-2xl text-red-500"></i></div><div><p class="text-sm font-medium text-slate-500">Za obaviti</p><p id="todo-count" class="text-3xl font-bold text-slate-800">0</p></div>
                        </div>
                        <div id="stat-card-inprogress" class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center cursor-pointer hover:shadow-lg hover:border-indigo-400 transition-all duration-300">
                            <div class="p-4 bg-amber-100 rounded-lg mr-5"><i class="fas fa-person-digging text-2xl text-amber-500"></i></div><div><p class="text-sm font-medium text-slate-500">U izradi</p><p id="inprogress-count" class="text-3xl font-bold text-slate-800">0</p></div>
                        </div>
                        <div id="stat-card-done" class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center cursor-pointer hover:shadow-lg hover:border-indigo-400 transition-all duration-300">
                            <div class="p-4 bg-emerald-100 rounded-lg mr-5"><i class="fas fa-check-double text-2xl text-emerald-500"></i></div><div><p class="text-sm font-medium text-slate-500">Gotovo</p><p id="done-count" class="text-3xl font-bold text-slate-800">0</p></div>
                        </div>
                    </div>
                    <!-- Progress Bar -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <div class="flex justify-between items-center mb-2"><h3 class="font-bold text-slate-800">Napredak projekta</h3><span id="progress-percentage" class="text-lg font-bold text-slate-600">0%</span></div>
                        <div class="w-full bg-red-200 rounded-full h-4"><div id="progress-bar-done" class="bg-emerald-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                    </div>
                    <!-- Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-200"><h3 class="font-bold text-slate-800 mb-4">Zaduženja po članu tima</h3><div class="relative h-64"><canvas id="assigneePieChart"></canvas></div></div>
                        <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-sm border border-slate-200"><h3 class="font-bold text-slate-800 mb-4">Napredak članova tima (%)</h3><div class="relative h-64"><canvas id="assigneeBarChart"></canvas></div></div>
                    </div>
                     <!-- Burn-down Chart -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-800 mb-4">Burn-down grafikon</h3>
                        <div class="relative h-64"><canvas id="burnDownChart"></canvas></div>
                    </div>
                     <!-- Deadlines & Activity -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 class="font-bold text-slate-800 mb-4">Pregled rokova</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><h4 class="font-semibold text-amber-600 mb-3"><i class="fas fa-hourglass-half mr-2"></i>Uskoro istječe rok</h4><ul id="due-soon-list" class="space-y-2 text-sm"></ul></div>
                                <div><h4 class="font-semibold text-red-600 mb-3"><i class="fas fa-exclamation-circle mr-2"></i>Rok premašen</h4><ul id="overdue-list" class="space-y-2 text-sm"></ul></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 class="font-bold text-slate-800 mb-4">Dnevnik aktivnosti</h3>
                            <div id="activity-log-container" class="space-y-4 max-h-48 overflow-y-auto pr-2"></div>
                        </div>
                    </div>`;

                if (tasks.length === 0) {
                    dashboardView.innerHTML = '<div class="text-center py-16 text-slate-500">Nema zadataka za prikaz nadzorne ploče.</div>';
                    return;
                }
                
                dashboardView.innerHTML = dashboardContent;

                // Add event listeners for stat cards
                document.getElementById('stat-card-todo').addEventListener('click', () => switchView('kanban'));
                document.getElementById('stat-card-inprogress').addEventListener('click', () => switchView('kanban'));
                document.getElementById('stat-card-done').addEventListener('click', () => switchView('kanban'));


                // --- 1. Izračun statistike ---
                const stats = tasks.reduce((acc, task) => {
                    acc[task.status] = (acc[task.status] || 0) + 1;
                    return acc;
                }, { todo: 0, inprogress: 0, done: 0 });

                const totalTasks = tasks.length;
                const donePercentage = totalTasks > 0 ? Math.round((stats.done / totalTasks) * 100) : 0;
                
                const today = new Date(); today.setHours(0,0,0,0);
                const dueSoonTasks = tasks.filter(t => {
                    if(t.status === 'done') return false;
                    if (!t.endDate) return false;
                    if (isOverdue(t.endDate)) return false;
                    const wd = workingDaysUntil(t.endDate);
                    return wd >= 0 && wd <= 3;
                });
                const overdueTasks = tasks.filter(t => {
                    if(t.status === 'done') return false;
                    if (!t.endDate) return false;
                    return isOverdue(t.endDate);
                });
                
                const assigneeData = tasks.reduce((acc, task) => {
                    const assignee = task.assignee || 'Nedodijeljen';
                    if (!acc[assignee]) acc[assignee] = { total: 0, done: 0 };
                    acc[assignee].total++;
                    if (task.status === 'done') acc[assignee].done++;
                    return acc;
                }, {});

                // --- 2. Ažuriranje UI elemenata ---
                document.getElementById('todo-count').textContent = stats.todo;
                document.getElementById('inprogress-count').textContent = stats.inprogress;
                document.getElementById('done-count').textContent = stats.done;
                
                document.getElementById('progress-percentage').textContent = `${donePercentage}%`;
                document.getElementById('progress-bar-done').style.width = `${donePercentage}%`;

                const renderDeadlineList = (listEl, taskArray) => {
                    listEl.innerHTML = taskArray.length > 0
                        ? taskArray.map(t => `<li class="p-2 bg-slate-50 rounded-md cursor-pointer hover:bg-slate-100 deadline-task-item" data-task-id="${t.id}">${t.title} <span class="text-slate-500">- Rok: ${t.endDate}</span></li>`).join('')
                        : `<li class="text-slate-500">Nema zadataka.</li>`;
                };
                renderDeadlineList(document.getElementById('due-soon-list'), dueSoonTasks);
                renderDeadlineList(document.getElementById('overdue-list'), overdueTasks);
                
                // Render Activity Log
                const logContainer = document.getElementById('activity-log-container');
                const activityLog = project.activityLog || [];

                if (activityLog.length > 0) {
                    logContainer.innerHTML = activityLog
                        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                        .map(entry => `
                            <div class="flex items-start text-sm">
                                <i class="fas fa-history text-slate-400 mt-1 mr-3"></i>
                                <div>
                                    <p class="text-slate-700">${entry.message}</p>
                                    <p class="text-xs text-slate-500">${formatTimeAgo(entry.timestamp)}</p>
                                </div>
                            </div>
                        `).join('');
                } else {
                    logContainer.innerHTML = '<p class="text-slate-500 text-center py-4">Nema aktivnosti za prikaz.</p>';
                }


                // --- 3. Crtanje grafikona ---
                if(assigneePieChart) assigneePieChart.destroy();
                if(assigneeBarChart) assigneeBarChart.destroy();
                if(burnDownChart) burnDownChart.destroy();
                
                const assigneeLabels = Object.keys(assigneeData);
                const assigneeTotalTasks = assigneeLabels.map(l => assigneeData[l].total);
                const assigneeDonePercentage = assigneeLabels.map(l => {
                    const data = assigneeData[l];
                    return data.total > 0 ? Math.round((data.done / data.total) * 100) : 0;
                });
                const chartColors = ['#6366f1', '#10b981', '#f59e0b', '#0ea5e9', '#ec4899', '#8b5cf6', '#14b8a6'];
                
                Chart.register(ChartDataLabels);

                assigneePieChart = new Chart('assigneePieChart', {
                    type: 'pie',
                    data: { labels: assigneeLabels, datasets: [{ label: 'Zadataka', data: assigneeTotalTasks, backgroundColor: chartColors }] },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        onClick: (evt) => {
                            const points = assigneePieChart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
                            if (points.length) {
                                const firstPoint = points[0];
                                const label = assigneePieChart.data.labels[firstPoint.index];
                                if (label && label !== 'Nedodijeljen') {
                                    switchView('workload');
                                    setTimeout(() => {
                                        const searchInput = document.getElementById('workloadSearch');
                                        if (searchInput) {
                                            searchInput.value = label;
                                            searchInput.dispatchEvent(new Event('input', { bubbles: true }));
                                        }
                                    }, 10);
                                }
                            }
                        },
                        plugins: { 
                            legend: { 
                                position: 'bottom', 
                                labels: { 
                                    boxWidth: 12 
                                } 
                            },
                            datalabels: {
                                formatter: (value, ctx) => {
                                    const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(0) + '%' : '0%';
                                    if ((value/total) * 100 < 5) return '';
                                    return percentage;
                                },
                                color: '#fff',
                                font: {
                                    weight: 'bold',
                                    size: 14,
                                }
                            }
                        } 
                    }
                });

                assigneeBarChart = new Chart('assigneeBarChart', {
                    type: 'bar',
                    data: { labels: assigneeLabels, datasets: [{ label: '% Dovršeno', data: assigneeDonePercentage, backgroundColor: chartColors[0] }] },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        onClick: (evt) => {
                            const points = assigneeBarChart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
                            if (points.length) {
                                const firstPoint = points[0];
                                const label = assigneeBarChart.data.labels[firstPoint.index];
                                if (label && label !== 'Nedodijeljen') {
                                    switchView('workload');
                                    setTimeout(() => {
                                        const searchInput = document.getElementById('workloadSearch');
                                        if (searchInput) {
                                            searchInput.value = label;
                                            searchInput.dispatchEvent(new Event('input', { bubbles: true }));
                                        }
                                    }, 10);
                                }
                            }
                        },
                        scales: { y: { beginAtZero: true, max: 100 } }, 
                        plugins: { 
                            legend: { display: false },
                            datalabels: {
                                anchor: 'center',
                                align: 'center',
                                color: '#fff',
                                font: {
                                    weight: 'bold'
                                },
                                formatter: (value) => value > 0 ? value + '%' : ''
                            }
                        } 
                    }
                });
                
                // --- 4. Burn-down Chart ---
                const burnDownCanvas = document.getElementById('burnDownChart');
                if (burnDownCanvas) {
                    const tasksWithDates = tasks.filter(t => t.startDate && t.endDate);
                    if (tasksWithDates.length > 1) {
                        const allStartDates = tasksWithDates.map(t => new Date(t.startDate));
                        const allEndDates = tasksWithDates.map(t => new Date(t.endDate));

                        const projectStartDate = new Date(Math.min.apply(null, allStartDates));
                        const projectEndDate = new Date(Math.max.apply(null, allEndDates));
                        
                        projectStartDate.setHours(0,0,0,0);
                        projectEndDate.setHours(0,0,0,0);

                        const durationDays = Math.ceil((projectEndDate - projectStartDate) / (1000 * 60 * 60 * 24)) + 1;
                        if (durationDays <= 0 || !project.activityLog) {
                            burnDownCanvas.parentElement.innerHTML = '<p class="text-center text-slate-500 p-8">Nema dovoljno podataka za burn-down grafikon.</p>';
                        } else {
                            const dailyDeltas = new Array(durationDays).fill(0);
                            const dayOne = new Date(projectStartDate);
                            dayOne.setHours(0,0,0,0);

                            // Process activity log to get daily changes in completed tasks
                            project.activityLog.forEach(entry => {
                                if (entry.newStatus) { // It's a status change event
                                    const entryDate = new Date(entry.timestamp);
                                    entryDate.setHours(0,0,0,0);
                                    
                                    const dayIndex = Math.floor((entryDate - dayOne) / (1000 * 60 * 60 * 24));

                                    if (dayIndex >= 0 && dayIndex < durationDays) {
                                        const isCompletion = entry.newStatus === 'done';
                                        const wasCompleted = entry.oldStatus === 'done';

                                        if (isCompletion && !wasCompleted) {
                                            dailyDeltas[dayIndex]--; // One task completed
                                        } else if (!isCompletion && wasCompleted) {
                                            dailyDeltas[dayIndex]++; // One task "un-completed"
                                        }
                                    }
                                }
                            });

                            let labels = [];
                            let idealData = [];
                            let actualData = [];
                            let remainingTasks = totalTasks;
                            const idealBurnPerDay = durationDays > 1 ? totalTasks / (durationDays - 1) : totalTasks;
                            const today = new Date();
                            today.setHours(0,0,0,0);

                            for (let i = 0; i < durationDays; i++) {
                                const currentDate = new Date(projectStartDate);
                                currentDate.setDate(projectStartDate.getDate() + i);
                                
                                labels.push(currentDate.toLocaleDateString('hr-HR', { day: 'numeric', month: 'short' }));
                                idealData.push(Math.round(Math.max(0, totalTasks - (i * idealBurnPerDay))));
                                
                                if (currentDate <= today) {
                                     if(i > 0) {
                                        remainingTasks = actualData[actualData.length - 1] + (dailyDeltas[i] || 0)
                                    } else {
                                        // On day 0, just apply the delta for day 0
                                        remainingTasks = totalTasks + (dailyDeltas[i] || 0)
                                    }
                                    actualData.push(remainingTasks);
                                }
                            }
                        
                            const isProjectComplete = remainingTasks <= 0 && actualData.length > 0;
                            const trophyIcon = new Image(20, 20);
                            trophyIcon.src = 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" fill="#f59e0b"><path d="M552 64H448V48C448 21.5 426.5 0 400 0H176c-26.5 0-48 21.5-48 48v16H24C10.7 64 0 74.7 0 88v32c0 13.3 10.7 24 24 24h13.2L65 481.3c2.4 21.3 20.3 37.4 41.8 38.6C129.5 523.5 160 493.1 160 456c0-11.8-3.1-22.7-8.6-32H128c-17.7 0-32-14.3-32-32s14.3-32 32-32h32.6c2.8-14.8 8.8-28.1 16.9-39.4C180.3 320 188.5 320 192 320h192c3.5 0 11.7 0 14.6 1.4c8.1 11.4 14.1 24.6 16.9 39.4H448c17.7 0 32 14.3 32 32s-14.3 32-32 32h-31.4c-5.5 9.3-8.6 20.2-8.6 32c0 37.1 30.5 67.5 52.8 71.9c21.5 1.2 39.4-14.7 41.8-38.6L538.8 144H552c13.3 0 24-10.7 24-24V88c0-13.3-10.7-24-24-24zM192 64h192v64H192V64z"/></svg>');
                            
                            let pointStyles = new Array(actualData.length).fill('circle');
                            let completionIndex = -1;
                            if (isProjectComplete) {
                                completionIndex = actualData.findIndex(d => d <= 0);
                                if(completionIndex !== -1) {
                                    pointStyles[completionIndex] = trophyIcon;
                                }
                            }

                            burnDownChart = new Chart('burnDownChart', {
                                type: 'line',
                                data: {
                                    labels: labels,
                                    datasets: [
                                        {
                                            label: 'Idealno preostalo',
                                            data: idealData,
                                            borderColor: '#94a3b8',
                                            borderDash: [5, 5],
                                            fill: false,
                                            tension: 0.1
                                        },
                                        {
                                            label: 'Stvarno preostalo',
                                            data: actualData,
                                            borderColor: '#4f46e5',
                                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                                            fill: true,
                                            tension: 0.1,
                                            pointStyle: pointStyles,
                                            pointRadius: (context) => (completionIndex !== -1 && context.dataIndex === completionIndex) ? 12 : 3,
                                        }
                                    ]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Broj preostalih zadataka' } } },
                                    plugins: { legend: { position: 'bottom' } }
                                }
                            });
                        }
                    }
                }
            };


            const handleTaskFormSubmit = (e) => {
                e.preventDefault();
                const id = document.getElementById('taskId').value;
                const projectId = document.getElementById('taskProjectId').value || getCurrentProject().id;
                let projectToUpdate = data.projects.find(p => p.id == projectId);

                 const subtaskNodes = document.querySelectorAll('#subtaskList .subtask-item');
                const subtasks = Array.from(subtaskNodes).map(node => ({
                    id: parseInt(node.dataset.id),
                    text: node.querySelector('label').textContent,
                    completed: node.querySelector('input[type="checkbox"]').checked
                }));

                const taskDependenciesSelect = document.getElementById('taskDependencies');
                const dependencies = Array.from(taskDependenciesSelect.selectedOptions).map(opt => parseInt(opt.value));

                const tagPills = document.querySelectorAll('#tag-pills-container .tag-pill');
                const tags = Array.from(tagPills).map(pill => pill.dataset.tag);

                const taskData = {
                    title: document.getElementById('taskTitle').value.trim(),
                    description: document.getElementById('taskDescription').value.trim(),
                    assignee: document.getElementById('taskAssignee').value.trim(),
                    startDate: document.getElementById('taskStartDate').value,
                    endDate: document.getElementById('taskEndDate').value,
                    priority: document.getElementById('taskPriority').value,
                    subtasks: subtasks,
                    dependencies: dependencies,
                    tags: tags
                    // Comments are handled separately
                };

                 if(!taskData.title || !taskData.assignee || !taskData.startDate || !taskData.endDate) {
                    alert('Molimo popunite sva obavezna polja.');
                    return;
                }

                if (id) { // Uređivanje
                    logActivity(`${taskData.assignee} je ažurirao/la zadatak "${taskData.title}".`, { taskId: parseInt(id) });
                    projectToUpdate.tasks = projectToUpdate.tasks.map(task => task.id == id ? { ...task, ...taskData } : task);

                } else { // Dodavanje
                    const newId = (projectToUpdate.tasks && projectToUpdate.tasks.length > 0) ? Math.max(...projectToUpdate.tasks.map(t => t.id)) + 1 : 1;
                    const preset = document.getElementById('taskStatusPreset').value;
                    const status = ['todo', 'inprogress', 'done'].includes(preset) ? preset : 'todo';
                    
                    const projectSelectWrapper = document.getElementById('taskProjectSelectWrapper');
                    if (!projectSelectWrapper.classList.contains('hidden')) {
                         const targetProjectId = parseInt(document.getElementById('taskProjectSelect').value);
                         projectToUpdate = data.projects.find(p => p.id == targetProjectId) || projectToUpdate;
                    }
                    if(!projectToUpdate.tasks) projectToUpdate.tasks = [];
                    
                    projectToUpdate.tasks.push({ ...taskData, id: newId, status, comments: [] }); // Add empty comments array for new task
                    logActivity(`${taskData.assignee} je kreirao/la zadatak "${taskData.title}".`, { taskId: newId, newStatus: status });
                }
                saveData();
                renderCurrentView();
                closeModal(taskModal, taskModalContent);
            };
            
            // --- Funkcije za oznake (Tags) ---
            const renderTagPills = (tags = []) => {
                const container = document.getElementById('tag-pills-container');
                container.innerHTML = '';
                tags.forEach(tag => {
                    const pill = document.createElement('div');
                    pill.className = 'tag-pill';
                    pill.dataset.tag = tag;
                    pill.innerHTML = `
                        <span>${tag}</span>
                        <button type="button" class="remove-tag text-indigo-400 hover:text-indigo-600"><i class="fas fa-times-circle fa-xs"></i></button>
                    `;
                    container.appendChild(pill);
                });
            };
             
            const addTag = (tag) => {
                if (tag) {
                    const formattedTag = '#' + tag.replace(/[^a-zA-Z0-9]/g, '');
                    const container = document.getElementById('tag-pills-container');
                    const existingTags = Array.from(container.querySelectorAll('.tag-pill')).map(p => p.dataset.tag);
                    if (!existingTags.includes(formattedTag)) {
                        renderTagPills([...existingTags, formattedTag]);
                    }
                }
            };
            
            const renderTagFilter = () => {
                const project = getCurrentProject();
                if (!project || !project.tasks) {
                    tagFilterContainer.innerHTML = '';
                    return;
                }

                const allTags = new Set();
                project.tasks.forEach(task => {
                    if (task.tags) {
                        task.tags.forEach(tag => allTags.add(tag));
                    }
                });

                if (allTags.size > 0) {
                    const options = Array.from(allTags).sort().map(tag => `<option value="${tag}">${tag}</option>`).join('');
                    tagFilterContainer.innerHTML = `
                        <select id="tagFilter" class="block w-full pl-3 pr-8 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                            <option value="">Sve oznake</option>
                            ${options}
                        </select>
                    `;
                    const select = document.getElementById('tagFilter');
                    select.value = activeTagFilter || "";
                    select.addEventListener('change', (e) => {
                        activeTagFilter = e.target.value || null;
                        renderCurrentView();
                    });
                } else {
                    tagFilterContainer.innerHTML = '';
                }
            };

            // --- Event listeneri ---
            projectSelector.addEventListener('change', handleProjectChange);
            newProjectBtn.addEventListener('click', () => openProjectModal(true));
            renameProjectBtn.addEventListener('click', () => openProjectModal(false));
            deleteProjectBtn.addEventListener('click', handleDeleteProject);
            addTaskBtn.addEventListener('click', () => openTaskModal());
            exportExcelBtn.addEventListener('click', () => {
                const project = getCurrentProject();
                if (!project || !project.tasks) return;
                const rows = project.tasks.map(t => ({
                    ID: t.id, Naziv: t.title, Opis: t.description, 'Zadužena osoba': t.assignee,
                    'Početak': t.startDate, 'Rok': t.endDate, Status: t.status, Prioritet: t.priority
                }));
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(rows.length ? rows : [{ Napomena: 'Nema zadataka' }]);
                XLSX.utils.book_append_sheet(wb, ws, project.name.substring(0,31));
                XLSX.writeFile(wb, `${project.name.replace(/[^\w\-]+/g,'_')}.xlsx`);
            });

            exportPdfBtn.addEventListener('click', () => {
                try {
                    const project = getCurrentProject();
                    if (!project || !project.tasks) {
                        alert('Nema projekta ili zadataka za izvoz!');
                        return;
                    }
                    
                    console.log('Počinje PDF generiranje...');
                
                // Funkcija za formatiranje datuma
                const formatDate = (dateString) => {
                    if (!dateString) return 'N/A';
                    const date = new Date(dateString);
                    const day = date.getDate().toString().padStart(2, '0');
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}.${month}.${year}`;
                };
                
                // Razdvoji zadatke po statusu
                const todoTasks = project.tasks.filter(t => t.status === 'todo');
                const inProgressTasks = project.tasks.filter(t => t.status === 'inprogress');
                const doneTasks = project.tasks.filter(t => t.status === 'done');
                
                // Kreiraj PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('portrait', 'mm', 'a4');
                
                // Postavke za hrvatske znakove i UTF-8
                doc.setProperties({
                    title: project.name,
                    subject: 'Vizualni prikaz zadataka',
                    author: 'PMO System',
                    creator: 'PMO System',
                    keywords: 'PMO, zadaci, projekt',
                    producer: 'PMO System'
                });
                
                // Postavke za UTF-8 kodiranje
                doc.internal.write('UTF-8');
                
                // DIZAJN U STILU SLIKE - Kartični stil s gradijentima
                
                // Naslov
                doc.setFontSize(24);
                doc.setFont('times', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text(project.name, 20, 30);
                
                // Podnaslov
                doc.setFontSize(16);
                doc.setFont('times', 'normal');
                doc.text('Vizualni prikaz zadataka', 20, 40);
                
                // Pozicije
                const leftX = 20;
                const rightX = 110;
                const startY = 60;
                const taskSpacing = 45;
                const maxY = 250;
                
                // TO-DO zaglavlje (lijevo) - centriran tekst
                doc.setFillColor(220, 38, 38); // crvena
                doc.roundedRect(leftX, startY - 15, 80, 12, 6, 6, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(14);
                doc.setFont('times', 'bold');
                // Centriranje teksta
                const todoText = 'TO-DO';
                const todoTextWidth = doc.getTextWidth(todoText);
                doc.text(todoText, leftX + (80 - todoTextWidth) / 2, startY - 5);
                
                // GOTOVO zaglavlje (desno) - centriran tekst
                doc.setFillColor(34, 197, 94); // zelena
                doc.roundedRect(rightX, startY - 15, 80, 12, 6, 6, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(14);
                doc.setFont('times', 'bold');
                // Centriranje teksta
                const gotovoText = 'GOTOVO';
                const gotovoTextWidth = doc.getTextWidth(gotovoText);
                doc.text(gotovoText, rightX + (80 - gotovoTextWidth) / 2, startY - 5);
                
                let currentY = startY + 10;
                
                // Za odraditi zadaci
                if (todoTasks.length > 0) {
                    doc.setFontSize(12);
                    doc.setFont('times', 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text('Za odraditi:', leftX, currentY);
                    currentY += 8;
                    
                    todoTasks.forEach((task, index) => {
                        if (currentY > maxY) {
                            doc.addPage();
                            currentY = 30;
                        }
                        
                        // Naziv zadatka - samo boldan tekst
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(10);
                        doc.setFont('times', 'bold');
                        const taskTitle = task.title.length > 20 ? task.title.substring(0, 20) + '...' : task.title;
                        doc.text(taskTitle, leftX, currentY + 5);
                        
                        // Status pill - crvena (centriran tekst)
                        doc.setFillColor(220, 38, 38);
                        doc.roundedRect(leftX + 65, currentY + 1, 25, 6, 3, 3, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(8);
                        doc.setFont('times', 'bold');
                        const zaOdraditiText = 'za odraditi';
                        const zaOdraditiWidth = doc.getTextWidth(zaOdraditiText);
                        doc.text(zaOdraditiText, leftX + 65 + (25 - zaOdraditiWidth) / 2, currentY + 4);
                        
                        currentY += 12;
                        
                        // Linija za odvajanje
                        doc.setDrawColor(100, 116, 139);
                        doc.setLineWidth(0.5);
                        doc.line(leftX, currentY, leftX + 80, currentY);
                        currentY += 5;
                        
                        // Detalji zadatka
                        doc.setFontSize(8);
                        doc.setTextColor(0, 0, 0);
                        doc.text(`• Postavljeno: ${formatDate(task.startDate)}`, leftX, currentY);
                        currentY += 4;
                        doc.text(`• Rok: ${formatDate(task.endDate)}`, leftX, currentY);
                        currentY += 4;
                        doc.text(`• Zadužen: ${task.assignee}`, leftX, currentY);
                        currentY += 8;
                    });
                }
                
                // U izradi zadaci
                if (inProgressTasks.length > 0) {
                    doc.setFontSize(12);
                    doc.setFont('times', 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text('U izradi:', leftX, currentY);
                    currentY += 8;
                    
                    inProgressTasks.forEach((task, index) => {
                        if (currentY > maxY) {
                            doc.addPage();
                            currentY = 30;
                        }
                        
                        // Naziv zadatka - samo boldan tekst
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(10);
                        doc.setFont('times', 'bold');
                        const taskTitle = task.title.length > 20 ? task.title.substring(0, 20) + '...' : task.title;
                        doc.text(taskTitle, leftX, currentY + 5);
                        
                        // Status pill - žuta (centriran tekst)
                        doc.setFillColor(255, 193, 7);
                        doc.roundedRect(leftX + 65, currentY + 1, 20, 6, 3, 3, 'F');
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(8);
                        doc.setFont('times', 'bold');
                        const uIzradiText = 'u izradi';
                        const uIzradiWidth = doc.getTextWidth(uIzradiText);
                        doc.text(uIzradiText, leftX + 65 + (20 - uIzradiWidth) / 2, currentY + 4);
                        
                        currentY += 12;
                        
                        // Linija za odvajanje
                        doc.setDrawColor(100, 116, 139);
                        doc.setLineWidth(0.5);
                        doc.line(leftX, currentY, leftX + 80, currentY);
                        currentY += 5;
                        
                        // Detalji zadatka
                        doc.setFontSize(8);
                        doc.setTextColor(0, 0, 0);
                        doc.text(`• Postavljeno: ${formatDate(task.startDate)}`, leftX, currentY);
                        currentY += 4;
                        doc.text(`• Rok: ${formatDate(task.endDate)}`, leftX, currentY);
                        currentY += 4;
                        doc.text(`• Zadužen: ${task.assignee}`, leftX, currentY);
                        currentY += 8;
                    });
                }
                
                // GOTOVO zadaci (desno)
                let doneY = startY + 10;
                if (doneTasks.length > 0) {
                    doneTasks.forEach((task, index) => {
                        if (doneY > maxY) {
                            doc.addPage();
                            doneY = 30;
                        }
                        
                        // Naziv zadatka - samo boldan tekst
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(10);
                        doc.setFont('times', 'bold');
                        const taskTitle = task.title.length > 20 ? task.title.substring(0, 20) + '...' : task.title;
                        doc.text(taskTitle, rightX, doneY + 5);
                        
                        // Status pill - zelena (centriran tekst)
                        doc.setFillColor(34, 197, 94);
                        doc.roundedRect(rightX + 65, doneY + 1, 20, 6, 3, 3, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(8);
                        doc.setFont('times', 'bold');
                        const gotovoText = 'gotovo';
                        const gotovoWidth = doc.getTextWidth(gotovoText);
                        doc.text(gotovoText, rightX + 65 + (20 - gotovoWidth) / 2, doneY + 4);
                        
                        doneY += 12;
                        
                        // Linija za odvajanje
                        doc.setDrawColor(100, 116, 139);
                        doc.setLineWidth(0.5);
                        doc.line(rightX, doneY, rightX + 80, doneY);
                        doneY += 5;
                        
                        // Detalji zadatka
                        doc.setFontSize(8);
                        doc.setTextColor(0, 0, 0);
                        doc.text(`• Završeno: ${formatDate(task.endDate)}`, rightX, doneY);
                        doneY += 4;
                        doc.text(`• Zadužen: ${task.assignee}`, rightX, doneY);
                        doneY += 8;
                    });
                }
                
                // Footer
                doc.setFillColor(50, 50, 50);
                doc.rect(0, 280, 210, 17, 'F');
                
                doc.setFontSize(10);
                doc.setTextColor(255, 255, 255);
                doc.setFont('times', 'normal');
                doc.text(`Generirano: ${new Date().toLocaleDateString('hr-HR')}`, 20, 290);
                doc.text(`Ukupno: ${project.tasks.length}`, 80, 290);
                doc.text(`Za odraditi: ${todoTasks.length}`, 120, 290);
                doc.text(`U izradi: ${inProgressTasks.length}`, 150, 290);
                doc.text(`Gotovo: ${doneTasks.length}`, 180, 290);
                
                // Spremi PDF
                console.log('Spremam PDF...');
                doc.save(`${project.name.replace(/[^\w\-]+/g,'_')}_vizualni_prikaz.pdf`);
                console.log('PDF uspješno spremljen!');
                } catch (error) {
                    console.error('Greška pri generiranju PDF-a:', error);
                    alert('Greška pri generiranju PDF-a: ' + error.message);
                }
            });
            viewTabs.forEach(tab => tab.addEventListener('click', () => switchView(tab.id.replace('Tab', ''))));
            
            // Modali
            cancelBtn.addEventListener('click', () => closeModal(taskModal, taskModalContent));
            cancelProjectBtn.addEventListener('click', () => closeModal(projectModal, projectModalContent));
            document.querySelectorAll('.cancel-btn-secondary').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modal = e.target.closest('.fixed');
                    const content = modal.querySelector('.transform');
                    closeModal(modal, content);
                })
            });
            taskModal.addEventListener('click', (e) => { if (e.target === taskModal) closeModal(taskModal, taskModalContent); });
            taskForm.addEventListener('submit', handleTaskFormSubmit);
            projectModal.addEventListener('click', (e) => { if (e.target === projectModal) closeModal(projectModal, projectModalContent); });
            projectForm.addEventListener('submit', handleProjectFormSubmit);
            confirmActionBtn.addEventListener('click', () => { if (typeof confirmCallback === 'function') confirmCallback(); closeModal(confirmModal, confirmModalContent); });
            cancelConfirmBtn.addEventListener('click', () => closeModal(confirmModal, confirmModalContent));
            confirmModal.addEventListener('click', (e) => { if (e.target === confirmModal) closeModal(confirmModal, confirmModalContent); });

            infoBtn.addEventListener('click', () => openModal(infoModal, infoModalContent));
            closeInfoBtn.addEventListener('click', () => closeModal(infoModal, infoModalContent));
            closeInfoBtnFooter.addEventListener('click', () => closeModal(infoModal, infoModalContent));
            infoModal.addEventListener('click', (e) => { if (e.target === infoModal) closeModal(infoModal, infoModalContent); });

             // Subtask listeners
            document.getElementById('addSubtaskBtn').addEventListener('click', () => {
                const input = document.getElementById('newSubtaskInput');
                const text = input.value.trim();
                if (text) {
                    const subtaskList = document.getElementById('subtaskList');
                    const newId = Date.now(); // Simple unique ID for now
                    const subtask = { id: newId, text, completed: false };

                    const subtaskEl = document.createElement('div');
                    subtaskEl.className = 'flex items-center gap-3 p-2 bg-slate-50 rounded-md subtask-item';
                    subtaskEl.dataset.id = subtask.id;

                    subtaskEl.innerHTML = `
                        <input type="checkbox" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                        <label class="flex-grow text-sm text-slate-800">${subtask.text}</label>
                        <button type="button" class="delete-subtask-btn text-slate-400 hover:text-red-600">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                    subtaskList.appendChild(subtaskEl);
                    input.value = '';
                }
            });

            document.getElementById('subtaskList').addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-subtask-btn');
                if (deleteBtn) {
                    deleteBtn.closest('.subtask-item').remove();
                }
            });

            // Comment listeners
            document.getElementById('addCommentBtn').addEventListener('click', () => {
                const taskId = document.getElementById('taskId').value;
                if (!taskId) return;

                const project = getCurrentProject();
                const task = project.tasks.find(t => t.id == taskId);
                const input = document.getElementById('newCommentInput');
                const text = input.value.trim();

                if (task && text) {
                    if (!task.comments) task.comments = [];
                    task.comments.push({
                        text: text,
                        author: 'Ja', // Placeholder for current user
                        timestamp: new Date().toISOString()
                    });
                    
                    logActivity(`Komentar je dodan na zadatak "${task.title}".`);
                    saveData();
                    renderCommentsList(task.comments);
                    renderCurrentView(); // Re-render to show comment icon
                    input.value = '';
                }
            });
            
            document.getElementById('task-comments-list').addEventListener('click', (e) => {
                const taskId = document.getElementById('taskId').value;
                if (!taskId) return;

                const project = getCurrentProject();
                const task = project.tasks.find(t => t.id == taskId);
                if (!task) return;

                const commentItem = e.target.closest('.comment-item');
                if (!commentItem) return;
                
                const commentId = commentItem.dataset.commentId;
                const comment = task.comments.find(c => c.timestamp === commentId);
                
                // Delete action
                const deleteBtn = e.target.closest('.delete-comment-btn');
                if (deleteBtn) {
                    showConfirmModal('Obriši komentar', 'Jeste li sigurni da želite obrisati ovaj komentar?', () => {
                        task.comments = task.comments.filter(c => c.timestamp !== commentId);
                        logActivity(`Komentar je obrisan sa zadatka "${task.title}".`);
                        saveData();
                        renderCommentsList(task.comments);
                        renderCurrentView(); // Update comment icon if needed
                    });
                    return;
                }

                // Edit action
                const editBtn = e.target.closest('.edit-comment-btn');
                if (editBtn) {
                    const contentDiv = commentItem.querySelector('.comment-content');
                    const currentText = comment.text;
                    
                    contentDiv.innerHTML = `
                        <textarea class="w-full text-sm p-2 bg-white border border-indigo-500 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-indigo-500">${currentText}</textarea>
                        <div class="flex justify-end gap-2 mt-2">
                            <button type="button" class="cancel-edit-comment-btn text-xs bg-slate-100 text-slate-700 font-semibold py-1 px-3 rounded-lg hover:bg-slate-200">Odustani</button>
                            <button type="button" class="save-comment-btn text-xs bg-indigo-600 text-white font-semibold py-1 px-3 rounded-lg hover:bg-indigo-700">Spremi</button>
                        </div>
                    `;
                    commentItem.querySelector('.comment-actions').classList.add('hidden');
                    return;
                }

                // Save edit action
                const saveBtn = e.target.closest('.save-comment-btn');
                if (saveBtn) {
                    const newText = commentItem.querySelector('textarea').value.trim();
                    if (newText && newText !== comment.text) {
                        comment.text = newText;
                        logActivity(`Komentar na zadatku "${task.title}" je uređen.`);
                        saveData();
                    }
                    renderCommentsList(task.comments); // Re-render to show normal view
                    return;
                }

                // Cancel edit action
                const cancelBtn = e.target.closest('.cancel-edit-comment-btn');
                if (cancelBtn) {
                    renderCommentsList(task.comments); // Just re-render to cancel
                    return;
                }
            });


            // Tag input listener
            const tagInput = document.getElementById('taskTagsInput');
            tagInput.addEventListener('keydown', (e) => {
                if (e.key === ',' || e.key === ' ' || e.key === 'Enter') {
                    e.preventDefault();
                    addTag(tagInput.value);
                    tagInput.value = '';
                }
            });

            document.getElementById('tag-pills-container').addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-tag');
                if(removeBtn) {
                    removeBtn.closest('.tag-pill').remove();
                }
            });

            // Delegacija događaja za klikove
            viewsContainer.addEventListener('click', (e) => {
                const project = getCurrentProject();
                if (!project) return;
                
                const findTask = (id) => (project.tasks || []).find(t => t.id == id);
                const findTaskFromCalendar = (taskId, projectId) => {
                    const p = data.projects.find(proj => proj.id == projectId);
                    return p ? (p.tasks || []).find(t => t.id == taskId) : null;
                }
                // Akcije
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                const statusMenuToggle = e.target.closest('.status-menu-toggle');
                const moveTaskBtn = e.target.closest('.move-task-btn');
                const columnAddBtn = e.target.closest('.column-add-btn');
                const calendarAddTaskBtn = e.target.closest('.add-task-day');
                const calendarTask = e.target.closest('[data-task-id][data-project-id]');
                // List View Actions
                const categoryAddBtn = e.target.closest('.category-add-btn');
                const categoryToggleBtn = e.target.closest('.category-toggle-btn');
                const taskStatusToggle = e.target.closest('.task-status-toggle');
                const listMoveTaskBtn = e.target.closest('.list-move-task-btn');
                const taskTitleLink = e.target.closest('.task-title-link');
                const deadlineTaskItem = e.target.closest('.deadline-task-item');
                const workloadTaskItem = e.target.closest('.workload-task-item');
                const roadmapBar = e.target.closest('.roadmap-bar-wrapper');


                if (editBtn) {
                    const task = findTask(editBtn.dataset.id);
                    if (task) openTaskModal(task);
                } else if (deleteBtn) {
                    const task = findTask(deleteBtn.dataset.id);
                    if (task) showConfirmModal('Obriši zadatak', `Želite li obrisati zadatak "<b>${task.title}</b>"?`, () => {
                        logActivity(`${task.assignee} je obrisao/la zadatak "${task.title}".`, { taskId: task.id });
                        project.tasks = project.tasks.filter(t => t.id != task.id);
                        saveData(); renderCurrentView();
                    });
                } else if (statusMenuToggle) {
                     document.querySelectorAll('.status-menu').forEach(menu => {
                       if (menu.id !== `status-menu-${statusMenuToggle.dataset.id}`) menu.classList.add('hidden');
                    });
                    document.getElementById(`status-menu-${statusMenuToggle.dataset.id}`).classList.toggle('hidden');
                } else if (moveTaskBtn) {
                    e.preventDefault();
                    const task = findTask(moveTaskBtn.dataset.id);
                    if (task) {
                        const newStatus = moveTaskBtn.dataset.newStatus;
                        const oldStatus = task.status;
                        if (oldStatus !== newStatus) {
                            task.status = newStatus;
                            logActivity(`${task.assignee} je pomaknuo/la zadatak "${task.title}" u "${statusLabels[newStatus]}".`, { taskId: task.id, oldStatus: oldStatus, newStatus: newStatus });
                            saveData(); renderCurrentView();
                        }
                    }
                } else if (columnAddBtn) {
                    const status = columnAddBtn.getAttribute('data-status');
                    openTaskModal(null, status);
                } else if (calendarAddTaskBtn) {
                    const date = calendarAddTaskBtn.getAttribute('data-date');
                    openTaskModal(null, 'todo');
                    document.getElementById('taskStartDate').value = date;
                    document.getElementById('taskEndDate').value = date;
                    document.getElementById('taskProjectSelectWrapper').classList.remove('hidden');
                } else if (calendarTask) {
                    const task = findTaskFromCalendar(calendarTask.dataset.taskId, calendarTask.dataset.projectId);
                    if(task) openTaskModal(task);
                } else if (categoryAddBtn) {
                    e.stopPropagation();
                    const status = categoryAddBtn.dataset.status;
                    openTaskModal(null, status);
                } else if (categoryToggleBtn) {
                    const taskList = categoryToggleBtn.nextElementSibling;
                    const icon = categoryToggleBtn.querySelector('.fas.fa-chevron-down, .fas.fa-chevron-right');
                    taskList.classList.toggle('hidden');
                    icon.classList.toggle('fa-chevron-down');
                    icon.classList.toggle('fa-chevron-right');
                    const status = categoryToggleBtn.dataset.status;
                    let listCategoryState = JSON.parse(localStorage.getItem('listCategoryState')) || {};
                    listCategoryState[status] = taskList.classList.contains('hidden');
                    localStorage.setItem('listCategoryState', JSON.stringify(listCategoryState));
                } else if (taskStatusToggle) {
                    e.preventDefault();
                    document.querySelectorAll('.list-status-menu').forEach(menu => {
                       if (menu.id !== `list-status-menu-${taskStatusToggle.dataset.id}`) menu.classList.add('hidden');
                    });
                    const menu = document.getElementById(`list-status-menu-${taskStatusToggle.dataset.id}`);
                    if (menu) menu.classList.toggle('hidden');
                } else if (listMoveTaskBtn) {
                    e.preventDefault();
                    const task = findTask(listMoveTaskBtn.dataset.id);
                    if (task) {
                        const newStatus = listMoveTaskBtn.dataset.newStatus;
                        const oldStatus = task.status;
                         if (oldStatus !== newStatus) {
                            task.status = newStatus;
                            logActivity(`${task.assignee} je pomaknuo/la zadatak "${task.title}" u "${statusLabels[newStatus]}".`, { taskId: task.id, oldStatus: oldStatus, newStatus: newStatus });
                            saveData(); renderCurrentView();
                        }
                    }
                } else if (taskTitleLink) {
                    e.preventDefault();
                    const task = findTask(taskTitleLink.dataset.id);
                    if (task) openTaskModal(task);
                } else if (deadlineTaskItem) {
                    const task = findTask(deadlineTaskItem.dataset.taskId);
                    if (task) openTaskModal(task);
                } else if (workloadTaskItem) {
                    const taskId = workloadTaskItem.dataset.taskId;
                    const projectId = workloadTaskItem.dataset.projectId;
                    const task = findTaskByProjectAndId(projectId, taskId);
                    if (task) openTaskModal(task);
                } else if (roadmapBar) {
                    const projectId = roadmapBar.dataset.projectId;
                    if(projectId) {
                        projectSelector.value = projectId;
                        handleProjectChange({target: {value: projectId}});
                        switchView('gantt');
                    }
                }
            });
            
            // Comment tooltip delegation for List View
            listView.addEventListener('mouseover', e => {
                const taskRow = e.target.closest('tr[data-task-id]');
                if (taskRow) {
                    const project = getCurrentProject();
                    const task = (project.tasks || []).find(t => t.id == taskRow.dataset.taskId);
                    if (task) showCommentTooltip(e, task);
                }
            });
            listView.addEventListener('mouseout', e => {
                if (e.target.closest('tr[data-task-id]')) {
                    hideCommentTooltip();
                }
            });


            document.body.addEventListener('click', (e) => {
                 if (!e.target.closest('#global-search-container')) {
                    globalSearchResults.classList.add('hidden');
                }
                if (!e.target.closest('.status-menu-toggle') && !e.target.closest('.status-menu')) {
                    document.querySelectorAll('.status-menu').forEach(menu => menu.classList.add('hidden'));
                }
                 if (!e.target.closest('.task-status-toggle') && !e.target.closest('.list-status-menu')) {
                    document.querySelectorAll('.list-status-menu').forEach(menu => menu.classList.add('hidden'));
                }
                const popup = e.target.closest('.gantt-popup-workload-link');
                if (popup) {
                    const assignee = popup.dataset.assignee;
                    if (assignee && assignee !== 'Nedodijeljeno') {
                        switchView('workload');
                        setTimeout(() => {
                            const searchInput = document.getElementById('workloadSearch');
                            if (searchInput) {
                                searchInput.value = assignee;
                                searchInput.dispatchEvent(new Event('input', { bubbles: true }));
                            }
                        }, 10);
                    }
                }
            }, true);

            // Drag and Drop
            kanbanColumns.forEach(col => {
                col.addEventListener('dragover', (e) => { e.preventDefault(); col.classList.add('drag-over'); });
                col.addEventListener('dragleave', () => col.classList.remove('drag-over'));
                col.addEventListener('drop', (e) => {
                    e.preventDefault();
                    col.classList.remove('drag-over');
                    const taskId = e.dataTransfer.getData('text/plain');
                    const newStatus = col.dataset.status;
                    const project = getCurrentProject();
                    const task = project.tasks.find(t => t.id == taskId);
                    if (task && task.status !== newStatus) {
                        const oldStatus = task.status;
                        task.status = newStatus;
                        logActivity(`${task.assignee} je pomaknuo/la zadatak "${task.title}" u "${statusLabels[newStatus]}".`, { taskId: task.id, oldStatus: oldStatus, newStatus: newStatus });
                        saveData(); renderCurrentView();
                    }
                });
            });
            
             // Global Search
            globalSearchInput.addEventListener('input', () => {
                const query = globalSearchInput.value.toLowerCase().trim();
                if (query.length < 2) {
                    globalSearchResults.innerHTML = '';
                    globalSearchResults.classList.add('hidden');
                    return;
                }

                const results = [];
                data.projects.forEach(project => {
                    (project.tasks || []).forEach(task => {
                        if (task.title.toLowerCase().includes(query) || task.description.toLowerCase().includes(query)) {
                            results.push({ ...task, projectName: project.name, projectId: project.id });
                        }
                    });
                });

                if (results.length > 0) {
                    globalSearchResults.innerHTML = results.map(task => `
                        <div class="p-3 hover:bg-slate-100 cursor-pointer border-b border-slate-100 search-result-item" data-task-id="${task.id}" data-project-id="${task.projectId}">
                            <p class="font-semibold text-sm text-slate-800">${task.title}</p>
                            <p class="text-xs text-slate-500">${task.projectName}</p>
                        </div>
                    `).join('');
                    globalSearchResults.classList.remove('hidden');
                } else {
                    globalSearchResults.innerHTML = `<p class="p-3 text-sm text-slate-500">Nema rezultata.</p>`;
                    globalSearchResults.classList.remove('hidden');
                }
            });

            globalSearchResults.addEventListener('click', (e) => {
                const item = e.target.closest('.search-result-item');
                if (item) {
                    const taskId = item.dataset.taskId;
                    const projectId = item.dataset.projectId;
                    const task = findTaskByProjectAndId(projectId, taskId);
                    if (task) {
                        openTaskModal(task);
                        globalSearchInput.value = '';
                        globalSearchResults.classList.add('hidden');
                    }
                }
            });

            // Data Import / Export
            exportDataBtn.addEventListener('click', () => {
                try {
                    const dataStr = JSON.stringify(data, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const date = new Date().toISOString().slice(0, 10);
                    a.download = `projectflow_backup_${date}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    console.error("Greška pri izvozu podataka:", error);
                    alert("Došlo je do greške pri izvozu podataka.");
                }
            });

            importDataBtn.addEventListener('click', () => {
                importFileInput.click();
            });

            importFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        // Simple validation
                        if (importedData && importedData.projects && importedData.currentProjectId !== undefined) {
                             showConfirmModal(
                                'Uvoz podataka',
                                'Jeste li sigurni da želite uvesti nove podatke? <b>Svi trenutni podaci bit će prepisani.</b>',
                                () => {
                                    data = importedData;
                                    saveData();
                                    renderProjects();
                                    renderCurrentView();
                                }
                            );
                        } else {
                            alert('Datoteka nije u ispravnom formatu.');
                        }
                    } catch (error) {
                        console.error("Greška pri uvozu podataka:", error);
                        alert('Došlo je do greške pri čitanju datoteke.');
                    } finally {
                        // Reset file input to allow importing the same file again
                        importFileInput.value = '';
                    }
                };
                reader.readAsText(file);
            });

            // --- Inicijalizacija ---
            renderProjects();
            // Postavljanje početnog datuma u modalima na današnji dan
            const todayStr = new Date().toISOString().split('T')[0];
            document.getElementById('taskStartDate').value = todayStr;
            document.getElementById('taskEndDate').value = todayStr;

            // Prvi render
            renderCurrentView();

            // Notifikacije: zatraži dopuštenje i pokreni periodičnu provjeru rokova
            requestNotificationPermissionIfNeeded().then(() => {
                try { checkAndNotifyDeadlines(); } catch (_) {}
                // Provjera svakih 15 minuta
                setInterval(() => {
                    try { checkAndNotifyDeadlines(); } catch (_) {}
                }, 15 * 60 * 1000);
            });
        });
    </script>
</body>
</html>

